<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CDR Almac√©n">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    <title>Casa Don Roberto - Sistema de Gesti√≥n</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body{font-family:Arial;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;margin:0}
        .container{max-width:1400px;margin:0 auto}
        h1{color:white;margin-bottom:10px}
        .sync-badge{display:inline-block;background:#10b981;color:white;padding:5px 12px;border-radius:20px;font-size:12px;margin-left:10px}
        .btn{padding:12px 24px;margin:5px;cursor:pointer;border:none;border-radius:8px;font-size:14px;font-weight:600;transition:all 0.2s}
        .btn:disabled{opacity:0.5;cursor:not-allowed}
        .card{background:white;padding:20px;border-radius:12px;margin:20px 0;box-shadow:0 4px 6px rgba(0,0,0,0.1);display:none}
        .card.active{display:block}
        .form-group{margin:15px 0}
        label{display:block;margin-bottom:5px;font-weight:600;color:#333}
        input,select,textarea{width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;box-sizing:border-box;font-family:Arial}
        button[type="submit"]{background:#10b981;color:white;width:100%;padding:12px;border:none;border-radius:6px;cursor:pointer;font-size:16px;font-weight:600}
        .btn-excel{background:#059669;color:white}
        .request-item{background:#f9f9f9;padding:20px;margin:10px 0;border-radius:8px;border-left:4px solid #e0e0e0}
        .request-item.excedente{border-left:4px solid #f59e0b;background:#fffbeb}
        .request-item.pendiente-conf{border-left:4px solid #0ea5e9;background:#e0f2fe}
        .request-item h3{margin:0 0 10px 0;color:#333}
        .request-item p{margin:5px 0;color:#666}
        .btn-approve{background:#3b82f6;color:white}
        .btn-deliver{background:#8b5cf6;color:white}
        .btn-parcialidad{background:#ec4899;color:white}
        .btn-eliminar{background:#ef4444;color:white;width:100%;margin-top:10px}
        .btn-autorizar{background:#10b981;color:white}
        .btn-rechazar{background:#ef4444;color:white}
        .status-pending{color:#f59e0b;font-weight:bold}
        .status-approved{color:#3b82f6;font-weight:bold}
        .status-partial{color:#8b5cf6;font-weight:bold}
        .status-delivered{color:#10b981;font-weight:bold}
        .status-pendiente_confirmacion{color:#0ea5e9;font-weight:bold}
        .status-excedente{color:#f59e0b;font-weight:bold}
        .parcialidad-item{background:#e0f2fe;padding:10px;margin:5px 0;border-radius:4px;font-size:14px;border-left:3px solid #0ea5e9}
        .faltante{color:#ef4444;font-weight:bold;font-size:16px}
        .excedente-warning{background:#fef3c7;border:2px solid #f59e0b;padding:15px;border-radius:8px;margin:10px 0}
        .excedente-warning h4{color:#92400e;margin:0 0 10px 0}
        .client-selector{background:#e0f2fe;border:2px solid #0ea5e9;padding:15px;border-radius:8px;margin-bottom:15px}
        .client-options{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .client-option{padding:12px;border:2px solid #bae6fd;background:white;border-radius:8px;cursor:pointer;text-align:center}
        .client-option:hover{border-color:#0ea5e9}
        .client-option.active{border-color:#0ea5e9;background:#0ea5e9;color:white}
        
        /* LOGIN STYLES */
        .login-container{display:flex;align-items:center;justify-content:center;min-height:100vh}
        .login-card{background:white;padding:40px;border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,0.2);max-width:400px;width:90%}
        .login-card h2{color:#333;margin-bottom:10px;text-align:center}
        .login-card p{color:#666;margin-bottom:30px;text-align:center;font-size:14px}
        .login-form .form-group{margin-bottom:20px}
        .login-form input{font-size:16px}
        .login-btn{background:#667eea;color:white;width:100%;padding:14px;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer}
        .login-btn:hover{background:#5568d3}
        .user-info{background:rgba(255,255,255,0.2);padding:10px 20px;border-radius:8px;display:inline-block;color:white;margin-left:20px}
        .btn-logout{background:#ef4444;color:white;padding:8px 16px;border-radius:6px;font-size:14px}
    </style>
</head>
<body>
    <!-- PANTALLA DE LOGIN -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div style="text-align:center;margin-bottom:20px">
                <img src="logo.png" alt="Casa Don Roberto" style="width:120px;height:120px;object-fit:contain">
            </div>
            <h2>üîê Sistema de Gesti√≥n</h2>
            <p>Ingresa tus credenciales para continuar</p>
            <form class="login-form" onsubmit="event.preventDefault();login()">
                <div class="form-group">
                    <label>Usuario</label>
                    <input type="text" id="loginUser" required placeholder="Ingresa tu usuario">
                </div>
                <div class="form-group">
                    <label>Contrase√±a</label>
                    <input type="password" id="loginPass" required placeholder="Ingresa tu contrase√±a">
                </div>
                <button type="submit" class="login-btn">Iniciar Sesi√≥n</button>
            </form>
            <div id="loginError" style="color:#ef4444;margin-top:15px;text-align:center;display:none"></div>
        </div>
    </div>
    
    <!-- PANTALLA PRINCIPAL (Oculta hasta login) -->
    <div id="mainScreen" style="display:none">
        <div class="container">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <div style="display:flex;align-items:center;gap:15px">
                    <img src="logo.png" alt="Casa Don Roberto" style="height:60px;width:60px;object-fit:contain">
                    <h1 style="margin:0">
                        Sistema de Gesti√≥n de Almac√©n 
                        <span class="sync-badge">üü¢ Conectado</span>
                    </h1>
                </div>
                <div>
                    <span class="user-info" id="userInfo"></span>
                    <button class="btn btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
            </div>
            
            <div style="background:white;padding:20px;border-radius:12px;margin-bottom:20px" id="navButtons">
                <button class="btn" id="btnMaterialista" onclick="mostrar('materialista')" style="background:#ec4899;color:white">üì¶ Entregas</button>
                <button class="btn" id="btnAlmacen" onclick="mostrar('almacen')" style="background:#8b5cf6;color:white">üè¢ Almac√©n</button>
                <button class="btn" id="btnExportaciones" onclick="mostrar('exportaciones')" style="background:#f59e0b;color:white">‚úàÔ∏è Exportaciones</button>
                <button class="btn" id="btnTrazabilidad" onclick="mostrar('trazabilidad')" style="background:#10b981;color:white">üìä Trazabilidad</button>
                <button class="btn" id="btnInventario" onclick="mostrar('inventario')" style="background:#3b82f6;color:white">üì¶ Inventario</button>
            </div>
            
            <!-- Estad√≠sticas -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px">
                <div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);border-left:4px solid #f59e0b">
                    <h3 style="margin:0 0 10px 0;color:#92400e;font-size:14px">Solicitudes Pendientes</h3>
                    <div style="font-size:36px;font-weight:bold;color:#f59e0b" id="statPendientes">0</div>
                </div>
                <div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);border-left:4px solid #3b82f6">
                    <h3 style="margin:0 0 10px 0;color:#1e40af;font-size:14px">En Proceso</h3>
                    <div style="font-size:36px;font-weight:bold;color:#3b82f6" id="statProceso">0</div>
                </div>
                <div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);border-left:4px solid #10b981">
                    <h3 style="margin:0 0 10px 0;color:#065f46;font-size:14px">Entregadas</h3>
                    <div style="font-size:36px;font-weight:bold;color:#10b981" id="statEntregadas">0</div>
                </div>
                <div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);border-left:4px solid #8b5cf6">
                    <h3 style="margin:0 0 10px 0;color:#5b21b6;font-size:14px">Recepciones Hoy</h3>
                    <div style="font-size:36px;font-weight:bold;color:#8b5cf6" id="statRecepciones">0</div>
                </div>
                <div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);border-left:4px solid #f59e0b">
                    <h3 style="margin:0 0 10px 0;color:#92400e;font-size:14px">Exportaciones Hoy</h3>
                    <div style="font-size:36px;font-weight:bold;color:#f59e0b" id="statExportaciones">0</div>
                </div>
            </div>
        </div>
        

        <!-- PRODUCCI√ìN ELIMINADO -->


        <div id="materialistaCard" class="card">
            <h2>üì¶ Entrega de Insumos a Producci√≥n</h2>
            <form onsubmit="event.preventDefault();registrarEntregaProduccion()">
                <div class="form-group"><label>Insumo *</label><select id="insumoEntrega" required></select></div>
                <div class="form-group"><label>Cantidad *</label><input type="number" id="cantidadEntrega" min="1" required></div>
                <div class="form-group"><label>Entregado a *</label><input type="text" id="receptorEntrega" required placeholder="Nombre de quien recibe"></div>
                <div class="form-group"><label>Notas</label><textarea id="notasEntrega" rows="2"></textarea></div>
                <div class="form-group"><label>Responsable *</label><input type="text" id="responsableEntrega" required readonly></div>
                <button type="submit">Registrar Entrega</button>
            </form>
            
            <div style="margin-top:30px;padding-top:20px;border-top:2px solid #e5e7eb">
                <h3>üìã Historial de Entregas</h3>
                <button class="btn btn-excel" onclick="descargarExcel()">üìä Excel Requisiciones</button>
                <div id="listaEntregas"></div>
            </div>
        </div>

        <div id="almacenCard" class="card">
            <h2>üì• Recepci√≥n de Proveedores</h2>
            <form onsubmit="event.preventDefault();registrarRecepcion()">
                <div class="form-group"><label>Factura *</label><input type="text" id="factura" required></div>
                <div class="form-group"><label>Proveedor *</label><input type="text" id="proveedor" required></div>
                <div class="form-group"><label>Insumo *</label><input type="text" id="insumoRecep" required></div>
                <div class="form-group"><label>Cantidad *</label><input type="number" id="cantidadRecep" min="1" required></div>
                <div class="form-group"><label>Responsable *</label><input type="text" id="responsableRecep" required></div>
                <button type="submit">Registrar Recepci√≥n</button>
            </form>
            
            <div style="margin-top:30px;padding-top:20px;border-top:2px solid #e5e7eb">
                <h3>üìã Historial de Recepciones</h3>
                <button class="btn btn-excel" onclick="descargarExcelAlmacen()">üìä Descargar Reporte Completo</button>
                <div id="listaRecepciones"></div>
            </div>
        </div>

        <div id="exportacionesCard" class="card">
            <h2>‚úàÔ∏è Registrar Exportaci√≥n</h2>
            <form onsubmit="event.preventDefault();registrarExportacion()">
                <div class="form-group"><label>N√∫mero de Pedido *</label><input type="text" id="pedido" required></div>
                <div class="form-group"><label>Presentaci√≥n *</label><select id="presentacion" required><option value="">Selecciona...</option><option>50 ml</option><option>375 ml</option><option>700 ml</option><option>750 ml</option><option>1000 ml</option><option>1750 ml</option></select></div>
                <div class="form-group"><label>Tipo *</label><select id="tipo" required><option value="">Selecciona...</option><option>Blanco</option><option>Reposado</option></select></div>
                <div class="form-group"><label>Cantidad de Pallets *</label><input type="number" id="cantidadPallets" min="1" required></div>
                <div class="form-group"><label>Cantidad de Cajas *</label><input type="number" id="cantidadCajas" min="1" required></div>
                <div class="form-group"><label>Cliente *</label><input type="text" id="clienteExp" required></div>
                <div class="form-group"><label>Transporte *</label><select id="transporte" required><option value="">Selecciona...</option><option>Terrestre</option><option>Mar√≠timo</option><option>A√©reo</option></select></div>
                <div class="form-group"><label>N√∫mero de Candado *</label><input type="text" id="numeroCandado" required></div>
                <div class="form-group"><label>Operador *</label><input type="text" id="operador" required></div>
                <div class="form-group"><label>Custodia *</label><input type="text" id="custodia" required></div>
                <div class="form-group"><label>Responsable *</label><input type="text" id="responsableExp" required readonly></div>
                <button type="submit">Registrar Exportaci√≥n</button>
            </form>
            
            <div style="margin-top:30px;padding-top:20px;border-top:2px solid #e5e7eb">
                <h3>üìã Historial de Exportaciones</h3>
                <button class="btn btn-excel" onclick="descargarExcelAlmacen()">üìä Descargar Reporte Completo</button>
                <div id="listaExportaciones"></div>
            </div>
        </div>

        <!-- TRAZABILIDAD -->
        <div id="trazabilidadCard" class="card">
            <h2>üìä Registro de Trazabilidad</h2>
            
            <!-- Datos Generales -->
            <div style="background:#e0f2fe;padding:20px;border-radius:8px;margin-bottom:20px">
                <h3 style="margin:0 0 15px 0">üìã Datos Generales</h3>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px">
                    <div class="form-group"><label>Presentaci√≥n *</label><select id="presentacionTraz" required onchange="calcularInsumosProduccion()"><option value="">Selecciona...</option><option>375ml</option><option>700 ml</option><option>750 ml</option><option>1000 ml</option><option>1750 ml</option></select></div>
                    <div class="form-group"><label>Tipo *</label><select id="tipoTraz" required onchange="calcularInsumosProduccion()"><option value="">Selecciona...</option><option>Blanco</option><option>Reposado</option></select></div>
                    <div class="form-group"><label>Cajas Producidas PT *</label><input type="number" id="cajasProducidas" min="1" required onchange="calcularInsumosProduccion()"></div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:15px">
                    <div class="form-group"><label>Lote de L√≠quido *</label><input type="text" id="loteLiquido" required></div>
                    <div class="form-group"><label>Pedido *</label><input type="text" id="pedidoTraz" required></div>
                    <div class="form-group"><label>Cliente *</label><input type="text" id="clienteTraz" required></div>
                </div>
                <div class="form-group"><label>Responsable *</label><input type="text" id="responsableTraz" required readonly></div>
            </div>
            
            <!-- Insumos Consumidos (Auto-calculado) -->
            <div style="background:#d1fae5;padding:20px;border-radius:8px;margin-bottom:20px" id="seccionInsumos">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                    <h3 style="margin:0">üì¶ Insumos Consumidos en Producci√≥n</h3>
                    <button type="button" class="btn" onclick="mostrarAgregarInsumoManual()" style="background:#3b82f6;color:white;padding:8px 16px;font-size:14px">‚ûï Agregar Insumo</button>
                </div>
                <p style="color:#666;font-size:14px;margin:0 0 15px 0">Auto-calculado seg√∫n la receta. Puedes ajustar cantidades si es necesario.</p>
                <div id="listaInsumosProduccion"></div>
            </div>
            
            <!-- Mermas -->
            <div style="background:#fef3c7;padding:20px;border-radius:8px;margin-bottom:20px">
                <h3 style="margin:0 0 15px 0">‚ö†Ô∏è Mermas (Opcional)</h3>
                <div style="display:grid;grid-template-columns:2fr 1fr auto;gap:10px;align-items:end">
                    <div class="form-group" style="margin:0">
                        <label>Insumo</label>
                        <select id="insumoMermaTemp">
                            <option value="">Selecciona...</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin:0">
                        <label>Cantidad</label>
                        <input type="number" id="cantidadMermaTemp" min="0" step="0.01" placeholder="0">
                    </div>
                    <button type="button" class="btn" onclick="agregarMerma()" style="background:#f59e0b;color:white;padding:10px 20px">‚ûï Agregar</button>
                </div>
                
                <div id="listaMermas" style="margin-top:15px"></div>
            </div>
            
            <button type="button" onclick="registrarTrazabilidad()" class="btn" style="background:#10b981;color:white;width:100%;padding:15px;font-size:16px">‚úÖ Registrar Trazabilidad Completa</button>
            
            <div style="margin-top:30px;padding-top:20px;border-top:2px solid #e5e7eb">
                <h3>üìã Historial de Trazabilidad</h3>
                <button class="btn btn-excel" onclick="descargarExcelTrazabilidad()">üìä Solo Trazabilidad</button>
                <button class="btn btn-excel" onclick="descargarExcelAlmacen()" style="background:#10b981">üìä Reporte Completo</button>
                <div id="listaTrazabilidad"></div>
            </div>
        </div>

        <!-- INVENTARIO -->
        <div id="inventarioCard" class="card">
            <h2>üì¶ Inventario de Insumos</h2>
            
            <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
                <input type="text" id="buscarInsumo" placeholder="üîç Buscar insumo..." style="flex:1;min-width:200px" onkeyup="filtrarInventario()">
                <button class="btn btn-excel" onclick="descargarExcelInventario()">üìä Excel Inventario</button>
                <button class="btn" onclick="mostrarKardex()" style="background:#8b5cf6;color:white">üìù Kardex</button>
                <button class="btn" onclick="mostrarFormularioAjuste()" style="background:#f59e0b;color:white">üîÑ Ajustar Stock</button>
                <button class="btn" onclick="mostrarFormularioCargaInicial()" style="background:#3b82f6;color:white">üì• Carga Inicial</button>
            </div>

            <div style="background:#e0f2fe;padding:15px;border-radius:8px;margin-bottom:20px">
                <h3 style="margin:0 0 10px 0">üìä Resumen</h3>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px">
                    <div style="background:white;padding:15px;border-radius:6px;text-align:center">
                        <div style="font-size:24px;font-weight:bold;color:#3b82f6" id="totalInsumos">0</div>
                        <div style="font-size:12px;color:#666">Total Insumos</div>
                    </div>
                    <div style="background:white;padding:15px;border-radius:6px;text-align:center">
                        <div style="font-size:24px;font-weight:bold;color:#10b981" id="insumosOK">0</div>
                        <div style="font-size:12px;color:#666">Stock OK</div>
                    </div>
                    <div style="background:white;padding:15px;border-radius:6px;text-align:center">
                        <div style="font-size:24px;font-weight:bold;color:#f59e0b" id="insumosBajos">0</div>
                        <div style="font-size:12px;color:#666">Stock Bajo</div>
                    </div>
                </div>
            </div>

            <div id="listaInventario"></div>
        </div>
    </div>
    <script>
const INSUMOS_MI_CAMPO=[{insumo:"BOTELLA",presentacion:"375ml",tipo:"GENERAL"},{insumo:"BOTELLA",presentacion:"700 ml",tipo:"GENERAL"},{insumo:"BOTELLA",presentacion:"750 ml",tipo:"GENERAL"},{insumo:"BOTELLA",presentacion:"1000 ml",tipo:"GENERAL"},{insumo:"BOTELLA",presentacion:"1750 ml",tipo:"GENERAL"},{insumo:"CAJA",presentacion:"375 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"375 ML",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"700 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"700 ML",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"750 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"750 ML",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"750 ML CANADA",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"750 ML CANADA",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"1000 ML",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"1000 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"1.750 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"1.750 ML",tipo:"REPOSADO"},{insumo:"TARIMA CHEP",presentacion:"EST√ÅNDAR MADERA",tipo:"GENERAL"},{insumo:"TARIMA",presentacion:"EST√ÅNDAR MADERA CON POLIN",tipo:"GENERAL"},{insumo:"TAPON PLASTICO",presentacion:"EST√ÅNDAR",tipo:"GENERAL"},{insumo:"CORCHO CASA NOBLE",presentacion:"EST√ÅNDAR",tipo:"GENERAL"},{insumo:"CELOSIL",presentacion:"EST√ÅNDAR",tipo:"GENERAL"},{insumo:"ESQUINEROS",presentacion:"KRAFT 2X2",tipo:"GENERAL"},{insumo:"ROLLOS PLAYO CHICO",presentacion:"18\"",tipo:"GENERAL"},{insumo:"ROLLOS PLAYO GRANDE",presentacion:"20\"",tipo:"GENERAL"},{insumo:"ROLLOS CINTA",presentacion:"48 X 150",tipo:"GENERAL"},{insumo:"ROLLOS FLEJE",presentacion:"1/2 negro",tipo:"GENERAL"},{insumo:"GRAPAS PZ",presentacion:"EST√ÅNDAR",tipo:"GENERAL"},{insumo:"ETIQUETA FRENTE",presentacion:"375 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"700 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"750 ML CANADA",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"1000 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"1750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"375 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"700 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"750 ML CANADA",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"750 ML USA",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"1000 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"1750 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"375 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"700 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"750 ML CANADA",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"1000 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"1750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"375 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"700 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"750 ML CANADA",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"750 ML USA",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"1000 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"1750 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CUELLO",presentacion:"375 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CUELLO",presentacion:"750/700/1000 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CUELLO",presentacion:"1750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CUELLO",presentacion:"375 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CUELLO",presentacion:"750/700/1000 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CUELLO",presentacion:"1750 ML",tipo:"REPOSADO"}];
// PELIGROSO ELIMINADO - Solo MI CAMPO

// CAT√ÅLOGO UNIFICADO PARA TRAZABILIDAD (sin repetir, con todos los insumos)
// Cat√°logo unificado para trazabilidad (solo MI CAMPO, sin 50ml)
const INSUMOS_TRAZABILIDAD=[{insumo:"BOTELLA",presentacion:"375ml",tipo:"GENERAL"},{insumo:"BOTELLA",presentacion:"700 ml",tipo:"GENERAL"},{insumo:"BOTELLA",presentacion:"750 ml",tipo:"GENERAL"},{insumo:"BOTELLA",presentacion:"1000 ml",tipo:"GENERAL"},{insumo:"BOTELLA",presentacion:"1750 ml",tipo:"GENERAL"},{insumo:"CAJA",presentacion:"375 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"375 ML",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"700 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"700 ML",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"750 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"750 ML",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"750 ML CANADA",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"750 ML CANADA",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"1000 ML",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"1000 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"1.750 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"1.750 ML",tipo:"REPOSADO"},{insumo:"TARIMA CHEP",presentacion:"EST√ÅNDAR MADERA",tipo:"GENERAL"},{insumo:"TARIMA",presentacion:"EST√ÅNDAR MADERA CON POLIN",tipo:"GENERAL"},{insumo:"TAPON PLASTICO",presentacion:"EST√ÅNDAR",tipo:"GENERAL"},{insumo:"CORCHO CASA NOBLE",presentacion:"EST√ÅNDAR",tipo:"GENERAL"},{insumo:"CELOSIL",presentacion:"EST√ÅNDAR",tipo:"GENERAL"},{insumo:"ESQUINEROS",presentacion:"KRAFT 2X2",tipo:"GENERAL"},{insumo:"ROLLOS PLAYO CHICO",presentacion:"18\"",tipo:"GENERAL"},{insumo:"ROLLOS PLAYO GRANDE",presentacion:"20\"",tipo:"GENERAL"},{insumo:"ROLLOS CINTA",presentacion:"48 X 150",tipo:"GENERAL"},{insumo:"ROLLOS FLEJE",presentacion:"1/2 negro",tipo:"GENERAL"},{insumo:"GRAPAS PZ",presentacion:"EST√ÅNDAR",tipo:"GENERAL"},{insumo:"ETIQUETA FRENTE",presentacion:"375 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"700 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"750 ML CANADA",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"1000 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"1750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"375 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"700 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"750 ML CANADA",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"750 ML USA",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"1000 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"1750 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"375 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"700 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"750 ML CANADA",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"1000 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"1750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"375 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"700 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"750 ML CANADA",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"750 ML USA",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"1000 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"1750 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CUELLO",presentacion:"375 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CUELLO",presentacion:"750/700/1000 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CUELLO",presentacion:"1750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CUELLO",presentacion:"375 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CUELLO",presentacion:"750/700/1000 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CUELLO",presentacion:"1750 ML",tipo:"REPOSADO"}];

// ============================================================================
// RECETAS DE PRODUCCI√ìN - AUTO-C√ÅLCULO DE INSUMOS
// ============================================================================
const RECETAS={
    '375ml-BLANCO':{botellas:12,insumos:[
        {key:'BOTELLA-375ML-GENERAL',nombre:'BOTELLA - 375ml - GENERAL',qty:12},
        {key:'CAJA-375-ML-BLANCO',nombre:'CAJA - 375 ML - BLANCO',qty:1},
        {key:'ETIQUETA-FRENTE-375-ML-BLANCO',nombre:'ETIQUETA FRENTE - 375 ML - BLANCO',qty:12},
        {key:'ETIQUETA-CONTRA-375-ML-BLANCO',nombre:'ETIQUETA CONTRA - 375 ML - BLANCO',qty:12},
        {key:'ETIQUETA-CUELLO-375-ML-BLANCO',nombre:'ETIQUETA CUELLO - 375 ML - BLANCO',qty:12},
        {key:'CELOSIL-EST√ÅNDAR-GENERAL',nombre:'CELOSIL - EST√ÅNDAR - GENERAL',qty:12},
        {key:'TAPON-PLASTICO-EST√ÅNDAR-GENERAL',nombre:'TAPON PLASTICO - EST√ÅNDAR - GENERAL',qty:12}
    ]},
    '375ml-REPOSADO':{botellas:12,insumos:[
        {key:'BOTELLA-375ML-GENERAL',nombre:'BOTELLA - 375ml - GENERAL',qty:12},
        {key:'CAJA-375-ML-REPOSADO',nombre:'CAJA - 375 ML - REPOSADO',qty:1},
        {key:'ETIQUETA-FRENTE-375-ML-REPOSADO',nombre:'ETIQUETA FRENTE - 375 ML - REPOSADO',qty:12},
        {key:'ETIQUETA-CONTRA-375-ML-REPOSADO',nombre:'ETIQUETA CONTRA - 375 ML - REPOSADO',qty:12},
        {key:'ETIQUETA-CUELLO-375-ML-REPOSADO',nombre:'ETIQUETA CUELLO - 375 ML - REPOSADO',qty:12},
        {key:'CELOSIL-EST√ÅNDAR-GENERAL',nombre:'CELOSIL - EST√ÅNDAR - GENERAL',qty:12},
        {key:'TAPON-PLASTICO-EST√ÅNDAR-GENERAL',nombre:'TAPON PLASTICO - EST√ÅNDAR - GENERAL',qty:12}
    ]},
    '700 ml-BLANCO':{botellas:6,insumos:[
        {key:'BOTELLA-700-ML-GENERAL',nombre:'BOTELLA - 700 ml - GENERAL',qty:6},
        {key:'CAJA-700-ML-BLANCO',nombre:'CAJA - 700 ML - BLANCO',qty:1},
        {key:'ETIQUETA-FRENTE-700-ML-BLANCO',nombre:'ETIQUETA FRENTE - 700 ML - BLANCO',qty:6},
        {key:'ETIQUETA-CONTRA-700-ML-BLANCO',nombre:'ETIQUETA CONTRA - 700 ML - BLANCO',qty:6},
        {key:'ETIQUETA-CUELLO-750-700-1000-ML-BLANCO',nombre:'ETIQUETA CUELLO - 750/700/1000 ML - BLANCO',qty:6},
        {key:'CELOSIL-EST√ÅNDAR-GENERAL',nombre:'CELOSIL - EST√ÅNDAR - GENERAL',qty:6},
        {key:'TAPON-PLASTICO-EST√ÅNDAR-GENERAL',nombre:'TAPON PLASTICO - EST√ÅNDAR - GENERAL',qty:6}
    ]},
    '700 ml-REPOSADO':{botellas:6,insumos:[
        {key:'BOTELLA-700-ML-GENERAL',nombre:'BOTELLA - 700 ml - GENERAL',qty:6},
        {key:'CAJA-700-ML-REPOSADO',nombre:'CAJA - 700 ML - REPOSADO',qty:1},
        {key:'ETIQUETA-FRENTE-700-ML-REPOSADO',nombre:'ETIQUETA FRENTE - 700 ML - REPOSADO',qty:6},
        {key:'ETIQUETA-CONTRA-700-ML-REPOSADO',nombre:'ETIQUETA CONTRA - 700 ML - REPOSADO',qty:6},
        {key:'ETIQUETA-CUELLO-750-700-1000-ML-REPOSADO',nombre:'ETIQUETA CUELLO - 750/700/1000 ML - REPOSADO',qty:6},
        {key:'CELOSIL-EST√ÅNDAR-GENERAL',nombre:'CELOSIL - EST√ÅNDAR - GENERAL',qty:6},
        {key:'TAPON-PLASTICO-EST√ÅNDAR-GENERAL',nombre:'TAPON PLASTICO - EST√ÅNDAR - GENERAL',qty:6}
    ]},
    '750 ml-BLANCO':{botellas:12,insumos:[
        {key:'BOTELLA-750-ML-GENERAL',nombre:'BOTELLA - 750 ml - GENERAL',qty:12},
        {key:'CAJA-750-ML-BLANCO',nombre:'CAJA - 750 ML - BLANCO',qty:1},
        {key:'ETIQUETA-FRENTE-750-ML-BLANCO',nombre:'ETIQUETA FRENTE - 750 ML - BLANCO',qty:12},
        {key:'ETIQUETA-CONTRA-750-ML-BLANCO',nombre:'ETIQUETA CONTRA - 750 ML - BLANCO',qty:12},
        {key:'ETIQUETA-CUELLO-750-700-1000-ML-BLANCO',nombre:'ETIQUETA CUELLO - 750/700/1000 ML - BLANCO',qty:12},
        {key:'CELOSIL-EST√ÅNDAR-GENERAL',nombre:'CELOSIL - EST√ÅNDAR - GENERAL',qty:12},
        {key:'TAPON-PLASTICO-EST√ÅNDAR-GENERAL',nombre:'TAPON PLASTICO - EST√ÅNDAR - GENERAL',qty:12}
    ]},
    '750 ml-REPOSADO':{botellas:12,insumos:[
        {key:'BOTELLA-750-ML-GENERAL',nombre:'BOTELLA - 750 ml - GENERAL',qty:12},
        {key:'CAJA-750-ML-REPOSADO',nombre:'CAJA - 750 ML - REPOSADO',qty:1},
        {key:'ETIQUETA-FRENTE-750-ML-CANADA-REPOSADO',nombre:'ETIQUETA FRENTE - 750 ML CANADA - REPOSADO',qty:12},
        {key:'ETIQUETA-CONTRA-750-ML-CANADA-REPOSADO',nombre:'ETIQUETA CONTRA - 750 ML CANADA - REPOSADO',qty:12},
        {key:'ETIQUETA-CUELLO-750-700-1000-ML-REPOSADO',nombre:'ETIQUETA CUELLO - 750/700/1000 ML - REPOSADO',qty:12},
        {key:'CELOSIL-EST√ÅNDAR-GENERAL',nombre:'CELOSIL - EST√ÅNDAR - GENERAL',qty:12},
        {key:'TAPON-PLASTICO-EST√ÅNDAR-GENERAL',nombre:'TAPON PLASTICO - EST√ÅNDAR - GENERAL',qty:12}
    ]},
    '1000 ml-BLANCO':{botellas:6,insumos:[
        {key:'BOTELLA-1000-ML-GENERAL',nombre:'BOTELLA - 1000 ml - GENERAL',qty:6},
        {key:'CAJA-1000-ML-BLANCO',nombre:'CAJA - 1000 ML - BLANCO',qty:1},
        {key:'ETIQUETA-FRENTE-1000-ML-BLANCO',nombre:'ETIQUETA FRENTE - 1000 ML - BLANCO',qty:6},
        {key:'ETIQUETA-CONTRA-1000-ML-BLANCO',nombre:'ETIQUETA CONTRA - 1000 ML - BLANCO',qty:6},
        {key:'ETIQUETA-CUELLO-750-700-1000-ML-BLANCO',nombre:'ETIQUETA CUELLO - 750/700/1000 ML - BLANCO',qty:6},
        {key:'CELOSIL-EST√ÅNDAR-GENERAL',nombre:'CELOSIL - EST√ÅNDAR - GENERAL',qty:6},
        {key:'TAPON-PLASTICO-EST√ÅNDAR-GENERAL',nombre:'TAPON PLASTICO - EST√ÅNDAR - GENERAL',qty:6}
    ]},
    '1000 ml-REPOSADO':{botellas:6,insumos:[
        {key:'BOTELLA-1000-ML-GENERAL',nombre:'BOTELLA - 1000 ml - GENERAL',qty:6},
        {key:'CAJA-1000-ML-REPOSADO',nombre:'CAJA - 1000 ML - REPOSADO',qty:1},
        {key:'ETIQUETA-FRENTE-1000-ML-REPOSADO',nombre:'ETIQUETA FRENTE - 1000 ML - REPOSADO',qty:6},
        {key:'ETIQUETA-CONTRA-1000-ML-REPOSADO',nombre:'ETIQUETA CONTRA - 1000 ML - REPOSADO',qty:6},
        {key:'ETIQUETA-CUELLO-750-700-1000-ML-REPOSADO',nombre:'ETIQUETA CUELLO - 750/700/1000 ML - REPOSADO',qty:6},
        {key:'CELOSIL-EST√ÅNDAR-GENERAL',nombre:'CELOSIL - EST√ÅNDAR - GENERAL',qty:6},
        {key:'TAPON-PLASTICO-EST√ÅNDAR-GENERAL',nombre:'TAPON PLASTICO - EST√ÅNDAR - GENERAL',qty:6}
    ]},
    '1750 ml-BLANCO':{botellas:3,insumos:[
        {key:'BOTELLA-1750-ML-GENERAL',nombre:'BOTELLA - 1750 ml - GENERAL',qty:3},
        {key:'CAJA-1750-ML-BLANCO',nombre:'CAJA - 1.750 ML - BLANCO',qty:1},
        {key:'ETIQUETA-FRENTE-1750-ML-BLANCO',nombre:'ETIQUETA FRENTE - 1750 ML - BLANCO',qty:3},
        {key:'ETIQUETA-CONTRA-1750-ML-BLANCO',nombre:'ETIQUETA CONTRA - 1750 ML - BLANCO',qty:3},
        {key:'ETIQUETA-CUELLO-1750-ML-BLANCO',nombre:'ETIQUETA CUELLO - 1750 ML - BLANCO',qty:3},
        {key:'CELOSIL-EST√ÅNDAR-GENERAL',nombre:'CELOSIL - EST√ÅNDAR - GENERAL',qty:3},
        {key:'TAPON-PLASTICO-EST√ÅNDAR-GENERAL',nombre:'TAPON PLASTICO - EST√ÅNDAR - GENERAL',qty:3}
    ]},
    '1750 ml-REPOSADO':{botellas:3,insumos:[
        {key:'BOTELLA-1750-ML-GENERAL',nombre:'BOTELLA - 1750 ml - GENERAL',qty:3},
        {key:'CAJA-1750-ML-REPOSADO',nombre:'CAJA - 1.750 ML - REPOSADO',qty:1},
        {key:'ETIQUETA-FRENTE-1750-ML-REPOSADO',nombre:'ETIQUETA FRENTE - 1750 ML - REPOSADO',qty:3},
        {key:'ETIQUETA-CONTRA-1750-ML-REPOSADO',nombre:'ETIQUETA CONTRA - 1750 ML - REPOSADO',qty:3},
        {key:'ETIQUETA-CUELLO-1750-ML-REPOSADO',nombre:'ETIQUETA CUELLO - 1750 ML - REPOSADO',qty:3},
        {key:'CELOSIL-EST√ÅNDAR-GENERAL',nombre:'CELOSIL - EST√ÅNDAR - GENERAL',qty:3},
        {key:'TAPON-PLASTICO-EST√ÅNDAR-GENERAL',nombre:'TAPON PLASTICO - EST√ÅNDAR - GENERAL',qty:3}
    ]}
};

function getReceta(presentacion,tipo){
    const key=presentacion+'-'+tipo;
    return RECETAS[key]||null;
}

function calcularInsumosProduccion(presentacion,tipo,cajas){
    const receta=getReceta(presentacion,tipo);
    if(!receta)return[];
    return receta.insumos.map(ins=>({nombre:ins.nombre,cantidad:ins.qty*cajas}));
}
// ============================================================================


// ============================================================================
// RECETAS DE PRODUCCI√ìN (10 recetas: 5 presentaciones √ó 2 tipos)
// ============================================================================
const RECETAS={'375-BLANCO':{presentacion:'375ml',tipo:'BLANCO',botellasPorCaja:12,insumos:[{nombre:'BOTELLA - 375ml - GENERAL',cantidadPorCaja:12},{nombre:'CAJA - 375 ML - BLANCO',cantidadPorCaja:1},{nombre:'ETIQUETA FRENTE - 375 ML - BLANCO',cantidadPorCaja:12},{nombre:'ETIQUETA CONTRA - 375 ML - BLANCO',cantidadPorCaja:12},{nombre:'ETIQUETA CUELLO - 375 ML - BLANCO',cantidadPorCaja:12},{nombre:'CELOSIL - EST√ÅNDAR - GENERAL',cantidadPorCaja:12},{nombre:'TAPON PLASTICO - EST√ÅNDAR - GENERAL',cantidadPorCaja:12}]},'375-REPOSADO':{presentacion:'375ml',tipo:'REPOSADO',botellasPorCaja:12,insumos:[{nombre:'BOTELLA - 375ml - GENERAL',cantidadPorCaja:12},{nombre:'CAJA - 375 ML - REPOSADO',cantidadPorCaja:1},{nombre:'ETIQUETA FRENTE - 375 ML - REPOSADO',cantidadPorCaja:12},{nombre:'ETIQUETA CONTRA - 375 ML - REPOSADO',cantidadPorCaja:12},{nombre:'ETIQUETA CUELLO - 375 ML - REPOSADO',cantidadPorCaja:12},{nombre:'CELOSIL - EST√ÅNDAR - GENERAL',cantidadPorCaja:12},{nombre:'TAPON PLASTICO - EST√ÅNDAR - GENERAL',cantidadPorCaja:12}]},'700-BLANCO':{presentacion:'700 ml',tipo:'BLANCO',botellasPorCaja:6,insumos:[{nombre:'BOTELLA - 700 ml - GENERAL',cantidadPorCaja:6},{nombre:'CAJA - 700 ML - BLANCO',cantidadPorCaja:1},{nombre:'ETIQUETA FRENTE - 700 ML - BLANCO',cantidadPorCaja:6},{nombre:'ETIQUETA CONTRA - 700 ML - BLANCO',cantidadPorCaja:6},{nombre:'ETIQUETA CUELLO - 750/700/1000 ML - BLANCO',cantidadPorCaja:6},{nombre:'CELOSIL - EST√ÅNDAR - GENERAL',cantidadPorCaja:6},{nombre:'TAPON PLASTICO - EST√ÅNDAR - GENERAL',cantidadPorCaja:6}]},'700-REPOSADO':{presentacion:'700 ml',tipo:'REPOSADO',botellasPorCaja:6,insumos:[{nombre:'BOTELLA - 700 ml - GENERAL',cantidadPorCaja:6},{nombre:'CAJA - 700 ML - REPOSADO',cantidadPorCaja:1},{nombre:'ETIQUETA FRENTE - 700 ML - REPOSADO',cantidadPorCaja:6},{nombre:'ETIQUETA CONTRA - 700 ML - REPOSADO',cantidadPorCaja:6},{nombre:'ETIQUETA CUELLO - 750/700/1000 ML - REPOSADO',cantidadPorCaja:6},{nombre:'CELOSIL - EST√ÅNDAR - GENERAL',cantidadPorCaja:6},{nombre:'TAPON PLASTICO - EST√ÅNDAR - GENERAL',cantidadPorCaja:6}]},'750-BLANCO':{presentacion:'750 ml',tipo:'BLANCO',botellasPorCaja:12,insumos:[{nombre:'BOTELLA - 750 ml - GENERAL',cantidadPorCaja:12},{nombre:'CAJA - 750 ML - BLANCO',cantidadPorCaja:1},{nombre:'ETIQUETA FRENTE - 750 ML - BLANCO',cantidadPorCaja:12},{nombre:'ETIQUETA CONTRA - 750 ML - BLANCO',cantidadPorCaja:12},{nombre:'ETIQUETA CUELLO - 750/700/1000 ML - BLANCO',cantidadPorCaja:12},{nombre:'CELOSIL - EST√ÅNDAR - GENERAL',cantidadPorCaja:12},{nombre:'TAPON PLASTICO - EST√ÅNDAR - GENERAL',cantidadPorCaja:12}]},'750-REPOSADO':{presentacion:'750 ml',tipo:'REPOSADO',botellasPorCaja:12,insumos:[{nombre:'BOTELLA - 750 ml - GENERAL',cantidadPorCaja:12},{nombre:'CAJA - 750 ML - REPOSADO',cantidadPorCaja:1},{nombre:'ETIQUETA FRENTE - 750 ML CANADA - REPOSADO',cantidadPorCaja:12},{nombre:'ETIQUETA CONTRA - 750 ML CANADA - REPOSADO',cantidadPorCaja:12},{nombre:'ETIQUETA CUELLO - 750/700/1000 ML - REPOSADO',cantidadPorCaja:12},{nombre:'CELOSIL - EST√ÅNDAR - GENERAL',cantidadPorCaja:12},{nombre:'TAPON PLASTICO - EST√ÅNDAR - GENERAL',cantidadPorCaja:12}]},'1000-BLANCO':{presentacion:'1000 ml',tipo:'BLANCO',botellasPorCaja:6,insumos:[{nombre:'BOTELLA - 1000 ml - GENERAL',cantidadPorCaja:6},{nombre:'CAJA - 1000 ML - BLANCO',cantidadPorCaja:1},{nombre:'ETIQUETA FRENTE - 1000 ML - BLANCO',cantidadPorCaja:6},{nombre:'ETIQUETA CONTRA - 1000 ML - BLANCO',cantidadPorCaja:6},{nombre:'ETIQUETA CUELLO - 750/700/1000 ML - BLANCO',cantidadPorCaja:6},{nombre:'CELOSIL - EST√ÅNDAR - GENERAL',cantidadPorCaja:6},{nombre:'TAPON PLASTICO - EST√ÅNDAR - GENERAL',cantidadPorCaja:6}]},'1000-REPOSADO':{presentacion:'1000 ml',tipo:'REPOSADO',botellasPorCaja:6,insumos:[{nombre:'BOTELLA - 1000 ml - GENERAL',cantidadPorCaja:6},{nombre:'CAJA - 1000 ML - REPOSADO',cantidadPorCaja:1},{nombre:'ETIQUETA FRENTE - 1000 ML - REPOSADO',cantidadPorCaja:6},{nombre:'ETIQUETA CONTRA - 1000 ML - REPOSADO',cantidadPorCaja:6},{nombre:'ETIQUETA CUELLO - 750/700/1000 ML - REPOSADO',cantidadPorCaja:6},{nombre:'CELOSIL - EST√ÅNDAR - GENERAL',cantidadPorCaja:6},{nombre:'TAPON PLASTICO - EST√ÅNDAR - GENERAL',cantidadPorCaja:6}]},'1750-BLANCO':{presentacion:'1750 ml',tipo:'BLANCO',botellasPorCaja:3,insumos:[{nombre:'BOTELLA - 1750 ml - GENERAL',cantidadPorCaja:3},{nombre:'CAJA - 1.750 ML - BLANCO',cantidadPorCaja:1},{nombre:'ETIQUETA FRENTE - 1750 ML - BLANCO',cantidadPorCaja:3},{nombre:'ETIQUETA CONTRA - 1750 ML - BLANCO',cantidadPorCaja:3},{nombre:'ETIQUETA CUELLO - 1750 ML - BLANCO',cantidadPorCaja:3},{nombre:'CELOSIL - EST√ÅNDAR - GENERAL',cantidadPorCaja:3},{nombre:'TAPON PLASTICO - EST√ÅNDAR - GENERAL',cantidadPorCaja:3}]},'1750-REPOSADO':{presentacion:'1750 ml',tipo:'REPOSADO',botellasPorCaja:3,insumos:[{nombre:'BOTELLA - 1750 ml - GENERAL',cantidadPorCaja:3},{nombre:'CAJA - 1.750 ML - REPOSADO',cantidadPorCaja:1},{nombre:'ETIQUETA FRENTE - 1750 ML - REPOSADO',cantidadPorCaja:3},{nombre:'ETIQUETA CONTRA - 1750 ML - REPOSADO',cantidadPorCaja:3},{nombre:'ETIQUETA CUELLO - 1750 ML - REPOSADO',cantidadPorCaja:3},{nombre:'CELOSIL - EST√ÅNDAR - GENERAL',cantidadPorCaja:3},{nombre:'TAPON PLASTICO - EST√ÅNDAR - GENERAL',cantidadPorCaja:3}]}};

firebase.initializeApp({apiKey:"AIzaSyAg-1IW4aE5KXUH4X_VN87NEquGA03972Q",authDomain:"cdr-insumos-2619a.firebaseapp.com",databaseURL:"https://cdr-insumos-2619a-default-rtdb.firebaseio.com",projectId:"cdr-insumos-2619a",storageBucket:"cdr-insumos-2619a.firebasestorage.app",messagingSenderId:"921324842813",appId:"1:921324842813:web:c28cdf61c97cb43c9adf54"});
// SISTEMA DE USUARIOS Y PERMISOS
const USUARIOS = {
    'cristian': {pass:'MAT2026',rol:'materialista',nombre:'Cristian'},
    'grecia': {pass:'MAT2026',rol:'materialista',nombre:'Grecia'},
    'miguel': {pass:'MAT2026',rol:'materialista',nombre:'Miguel'},
    'cristian.montacargas': {pass:'MAT2026',rol:'materialista',nombre:'Cristian (Montacargas)'},
    'esperanza': {pass:'PRO2026',rol:'produccion',nombre:'Esperanza'},
    'jairo': {pass:'PRO2026',rol:'produccion',nombre:'Jairo'},
    'fatima': {pass:'PRO2026',rol:'produccion',nombre:'F√°tima'},
    'jose.manuel': {pass:'PRO2026',rol:'produccion',nombre:'Jos√© Manuel'},
    'juan': {pass:'ALMA2026',rol:'almacen',nombre:'Juan'},
    'eva': {pass:'ALMA2026',rol:'almacen',nombre:'Eva'},
    'trazabilidad': {pass:'TRAZA2026',rol:'trazabilidad',nombre:'Trazabilidad'},
    'orlando': {pass:'ADMIN2026',rol:'admin',nombre:'Orlando'},
    'marisol': {pass:'ADMIN2026',rol:'admin',nombre:'Marisol'},
    'david': {pass:'ADMIN2026',rol:'admin',nombre:'David'}
};
const PERMISOS={produccion:['materialista','trazabilidad','inventario'],materialista:['materialista','almacen','inventario'],almacen:['materialista','almacen','exportaciones','inventario'],trazabilidad:['trazabilidad'],admin:['materialista','almacen','exportaciones','trazabilidad','inventario']};
let currentUser=null;
const database=firebase.database();

let solicitudes=[],recepciones=[],exportaciones=[],trazabilidad=[],entregas=[],inventario=[],filtroActual='all',currentClient='MI_CAMPO',currentInsumos=INSUMOS_MI_CAMPO;

database.ref('requests').on('value',s=>{solicitudes=s.val()?Object.values(s.val()):[];actualizarEstadisticas();});
database.ref('recepciones').on('value',s=>{recepciones=s.val()?Object.values(s.val()):[];mostrarRecepciones();actualizarEstadisticas();});
database.ref('exportaciones').on('value',s=>{exportaciones=s.val()?Object.values(s.val()):[];mostrarExportaciones();actualizarEstadisticas();});
database.ref('trazabilidad').on('value',s=>{trazabilidad=s.val()?Object.values(s.val()):[];mostrarTrazabilidad();});
database.ref('entregas').on('value',s=>{entregas=s.val()?Object.values(s.val()):[];if(document.getElementById('materialistaCard').classList.contains('active'))mostrarEntregas();});
database.ref('inventario').on('value',s=>{inventario=s.val()?Object.values(s.val()):[];if(document.getElementById('inventarioCard').classList.contains('active')){mostrarInventario();actualizarResumenInventario();}});

function login(){const u=document.getElementById("loginUser").value.trim().toLowerCase();const p=document.getElementById("loginPass").value;if(USUARIOS[u]&&USUARIOS[u].pass===p){currentUser={user:u,...USUARIOS[u]};document.getElementById("loginScreen").style.display="none";document.getElementById("mainScreen").style.display="block";document.getElementById("userInfo").textContent="üë§ "+currentUser.nombre+" ("+currentUser.rol.toUpperCase()+")";document.getElementById("responsableRecep").value=currentUser.nombre;document.getElementById("responsableExp").value=currentUser.nombre;document.getElementById("responsableEntrega").value=currentUser.nombre;document.getElementById("responsableTraz").value=currentUser.nombre;aplicarPermisos();mostrar(PERMISOS[currentUser.rol][0]);}else{document.getElementById("loginError").textContent="‚ùå Usuario o contrase√±a incorrectos";document.getElementById("loginError").style.display="block";}}
function logout(){if(confirm("¬øCerrar sesi√≥n?")){location.reload();}}
function aplicarPermisos(){const p=PERMISOS[currentUser.rol];document.getElementById("btnMaterialista").disabled=!p.includes("materialista");document.getElementById("btnAlmacen").disabled=!p.includes("almacen");document.getElementById("btnExportaciones").disabled=!p.includes("exportaciones");document.getElementById("btnTrazabilidad").disabled=!p.includes("trazabilidad");document.getElementById("btnInventario").disabled=!p.includes("inventario");}

// ============================================================================
// FUNCIONES OBSOLETAS - PRODUCCI√ìN ELIMINADA
// ============================================================================
/*
function cargarInsumos(){
    const s=document.getElementById('insumo');
    s.innerHTML='<option value="">Selecciona...</option>';
    currentInsumos.forEach((item,i)=>{
        const o=document.createElement('option');
        o.value=i;
        o.textContent=item.insumo+' - '+item.presentacion+' - '+item.tipo;
        s.appendChild(o);
    });
}

function selectClient(c,e){
    if(e){e.preventDefault();e.stopPropagation();}
    currentClient=c;
    currentInsumos=c==='MI_CAMPO'?INSUMOS_MI_CAMPO:INSUMOS_PELIGROSO;
    document.querySelectorAll('.client-option').forEach(o=>o.classList.remove('active'));
    if(e&&e.target){const opt=e.target.closest('.client-option');if(opt)opt.classList.add('active');}
    cargarInsumos();
}
*/
// ============================================================================

let mermasTemp=[];
let insumosProduccionTemp=[];

// ============================================================================
// FUNCIONES DE RECETAS Y AUTO-C√ÅLCULO
// ============================================================================
function calcularInsumosProduccion(){
    const pres=document.getElementById('presentacionTraz').value;
    const tipo=document.getElementById('tipoTraz').value;
    const cajas=parseInt(document.getElementById('cajasProducidas').value)||0;
    
    if(!pres||!tipo||cajas===0){
        insumosProduccionTemp=[];
        mostrarInsumosProduccion();
        return;
    }
    
    const keyReceta=pres+'-'+tipo.toUpperCase();
    const receta=RECETAS[keyReceta];
    
    if(!receta){
        alert('‚ö†Ô∏è No se encontr√≥ receta para '+pres+' '+tipo);
        insumosProduccionTemp=[];
        mostrarInsumosProduccion();
        return;
    }
    
    insumosProduccionTemp=receta.insumos.map(ins=>({
        nombre:ins.nombre,
        cantidad:ins.qty*cajas
    }));
    
    mostrarInsumosProduccion();
}

function mostrarInsumosProduccion(){
    const lista=document.getElementById('listaInsumosProduccion');
    
    if(insumosProduccionTemp.length===0){
        lista.innerHTML='<p style="color:#666;text-align:center;padding:20px">Selecciona presentaci√≥n, tipo y cajas para calcular insumos</p>';
        return;
    }
    
    lista.innerHTML=`
        <div style="background:white;border-radius:6px;overflow:hidden">
            ${insumosProduccionTemp.map((ins,idx)=>`
                <div style="padding:12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center">
                    <div style="flex:1">
                        <strong>${ins.nombre}</strong>
                    </div>
                    <div style="display:flex;align-items:center;gap:10px">
                        <input type="number" value="${ins.cantidad}" min="0" 
                            onchange="ajustarCantidadInsumo(${idx},this.value)"
                            style="width:100px;padding:8px;border:2px solid #ddd;border-radius:4px;text-align:right">
                        <span style="color:#666;width:80px">unidades</span>
                        <button onclick="eliminarInsumoProduccion(${idx})" class="btn" style="background:#ef4444;color:white;padding:8px 12px;font-size:12px">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function ajustarCantidadInsumo(idx,nuevaCantidad){
    insumosProduccionTemp[idx].cantidad=parseInt(nuevaCantidad)||0;
}

function eliminarInsumoProduccion(idx){
    if(confirm('¬øEliminar este insumo de la lista?')){
        insumosProduccionTemp.splice(idx,1);
        mostrarInsumosProduccion();
    }
}

function mostrarAgregarInsumoManual(){
    const modal=`
        <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999" id="modalInsumoManual" onclick="if(event.target.id==='modalInsumoManual')cerrarModal()">
            <div style="background:white;padding:30px;border-radius:12px;max-width:500px;width:90%" onclick="event.stopPropagation()">
                <h3>‚ûï Agregar Insumo Manualmente</h3>
                <div class="form-group">
                    <label>Insumo *</label>
                    <select id="insumoManual" required>
                        <option value="">Selecciona...</option>
                        ${INSUMOS_TRAZABILIDAD.map(i=>`<option value="${i.insumo} - ${i.presentacion} - ${i.tipo}">${i.insumo} - ${i.presentacion} - ${i.tipo}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>Cantidad *</label>
                    <input type="number" id="cantidadManual" min="1" value="1" required>
                </div>
                <div style="display:flex;gap:10px;margin-top:20px">
                    <button onclick="agregarInsumoManual()" class="btn" style="background:#10b981;color:white;flex:1">‚úÖ Agregar</button>
                    <button onclick="cerrarModal()" class="btn" style="background:#6b7280;color:white">‚ùå Cancelar</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend',modal);
}

function agregarInsumoManual(){
    const nombre=document.getElementById('insumoManual').value;
    const cantidad=parseInt(document.getElementById('cantidadManual').value)||0;
    
    if(!nombre||cantidad===0){
        alert('‚ö†Ô∏è Completa todos los campos');
        return;
    }
    
    insumosProduccionTemp.push({nombre,cantidad});
    mostrarInsumosProduccion();
    cerrarModal();
}
// ============================================================================

function cargarInsumosMerma(){
    const s=document.getElementById('insumoMermaTemp');
    s.innerHTML='<option value="">Selecciona...</option>';
    INSUMOS_TRAZABILIDAD.forEach((item,i)=>{
        const o=document.createElement('option');
        o.value=JSON.stringify(item);
        o.textContent=item.insumo+' - '+item.presentacion+' - '+item.tipo;
        s.appendChild(o);
    });
}

function agregarMerma(){
    const insumoSelect=document.getElementById('insumoMermaTemp');
    const cantidad=parseFloat(document.getElementById('cantidadMermaTemp').value);
    
    if(!insumoSelect.value){
        alert('‚ùå Selecciona un insumo');
        return;
    }
    if(!cantidad || cantidad<=0){
        alert('‚ùå Ingresa una cantidad v√°lida');
        return;
    }
    
    const insumoData=JSON.parse(insumoSelect.value);
    const merma={
        insumo:insumoData.insumo+' - '+insumoData.presentacion+' - '+insumoData.tipo,
        cantidad:cantidad
    };
    
    mermasTemp.push(merma);
    mostrarMermasTemp();
    
    // Limpiar campos
    insumoSelect.selectedIndex=0;
    document.getElementById('cantidadMermaTemp').value='';
}

function mostrarMermasTemp(){
    const lista=document.getElementById('listaMermas');
    if(mermasTemp.length===0){
        lista.innerHTML='<p style="color:#92400e;font-style:italic;margin-top:10px">No hay mermas agregadas. Agrega al menos una.</p>';
        return;
    }
    
    lista.innerHTML='<div style="background:white;padding:15px;border-radius:8px;margin-top:10px">'+
        '<h4 style="margin:0 0 10px 0;color:#92400e">Mermas agregadas ('+mermasTemp.length+'):</h4>'+
        mermasTemp.map((m,i)=>`
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:#fef3c7;border-radius:4px;margin:5px 0">
                <span><strong>${m.insumo}:</strong> ${m.cantidad}</span>
                <button onclick="eliminarMermaTemp(${i})" class="btn" style="background:#ef4444;color:white;padding:5px 10px;font-size:12px">üóëÔ∏è</button>
            </div>
        `).join('')+
    '</div>';
}

function eliminarMermaTemp(index){
    mermasTemp.splice(index,1);
    mostrarMermasTemp();
}

function registrarTrazabilidad(){
    // Validar campos
    if(!document.getElementById('presentacionTraz').value){alert('‚ùå Selecciona presentaci√≥n');return;}
    if(!document.getElementById('tipoTraz').value){alert('‚ùå Selecciona tipo');return;}
    if(!document.getElementById('cajasProducidas').value){alert('‚ùå Ingresa cajas producidas');return;}
    if(!document.getElementById('loteLiquido').value){alert('‚ùå Ingresa lote de l√≠quido');return;}
    if(!document.getElementById('pedidoTraz').value){alert('‚ùå Ingresa pedido');return;}
    if(!document.getElementById('clienteTraz').value){alert('‚ùå Ingresa cliente');return;}
    
    if(insumosProduccionTemp.length===0){
        alert('‚ùå Debes tener al menos un insumo consumido (auto-calculado o manual)');
        return;
    }
    
    const ahora=new Date();
    const dia=String(ahora.getDate()).padStart(2,'0');
    const mes=String(ahora.getMonth()+1).padStart(2,'0');
    const a√±o=ahora.getFullYear();
    const fechaStr=dia+mes+a√±o;
    const trazsHoy=trazabilidad.filter(t=>t.id.startsWith('TRAZ'+fechaStr));
    const consecutivo=trazsHoy.length+1;
    const id=`TRAZ${fechaStr}-${consecutivo}`;
    
    // Fecha y hora autom√°ticas
    const fechaISO=ahora.toISOString().split('T')[0];
    const hora=ahora.toTimeString().slice(0,5);
    
    const datos={
        id:id,
        presentacion:document.getElementById('presentacionTraz').value,
        tipo:document.getElementById('tipoTraz').value,
        cajasProducidas:parseInt(document.getElementById('cajasProducidas').value),
        insumosConsumidos:insumosProduccionTemp,
        mermas:mermasTemp,
        loteLiquido:document.getElementById('loteLiquido').value,
        pedido:document.getElementById('pedidoTraz').value,
        cliente:document.getElementById('clienteTraz').value,
        fecha:fechaISO,
        hora:hora,
        responsable:document.getElementById('responsableTraz').value,
        timestamp:ahora.toISOString()
    };
    
    // Guardar trazabilidad Y actualizar inventario
    database.ref('trazabilidad/'+id).set(datos)
        .then(()=>{
            // ACTUALIZAR INVENTARIO: Descontar insumos consumidos y mermas de Producci√≥n
            return actualizarInventarioTrazabilidad(insumosProduccionTemp, mermasTemp);
        })
        .then(()=>{
            alert('‚úÖ Trazabilidad registrada: '+id+'\n\nüì¶ Insumos consumidos: '+insumosProduccionTemp.length+'\n‚ö†Ô∏è Mermas: '+mermasTemp.length+'\nüìä Inventario actualizado');
            limpiarFormularioTrazabilidad();
        })
        .catch(err=>{
            console.error('Error:', err);
            alert('Error: '+err.message);
        });
}

function limpiarFormularioTrazabilidad(){
    mermasTemp=[];
    insumosProduccionTemp=[];
    mostrarMermasTemp();
    mostrarInsumosProduccion();
    document.getElementById('presentacionTraz').selectedIndex=0;
    document.getElementById('tipoTraz').selectedIndex=0;
    document.getElementById('cajasProducidas').value='';
    document.getElementById('loteLiquido').value='';
    document.getElementById('pedidoTraz').value='';
    document.getElementById('clienteTraz').value='';
    document.getElementById('responsableTraz').value=currentUser.nombre;
}

function mostrarTrazabilidad(){
    const lista=document.getElementById('listaTrazabilidad');
    if(trazabilidad.length===0){
        lista.innerHTML='<p style="color:#666">No hay registros de trazabilidad</p>';
        return;
    }
    lista.innerHTML=trazabilidad.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)).map(t=>`
        <div class="request-item">
            <h3>${t.id}</h3>
            <p><strong>Fecha:</strong> ${t.fecha} - <strong>Hora:</strong> ${t.hora}</p>
            <p><strong>Producto:</strong> ${t.presentacion||'N/A'} ${t.tipo}</p>
            <p><strong>Cajas Producidas PT:</strong> ${t.cajasProducidas}</p>
            ${t.insumosConsumidos && t.insumosConsumidos.length>0?`
            <div style="background:#d1fae5;padding:10px;border-radius:4px;margin:10px 0">
                <strong>üì¶ Insumos Consumidos (${t.insumosConsumidos.length}):</strong>
                ${t.insumosConsumidos.map(ins=>`<div style="margin:5px 0">‚Ä¢ ${ins.nombre}: <strong>${ins.cantidad}</strong></div>`).join('')}
            </div>
            `:''}
            ${t.mermas && t.mermas.length>0?`
            <div style="background:#fef3c7;padding:10px;border-radius:4px;margin:10px 0">
                <strong>‚ö†Ô∏è Mermas (${t.mermas.length}):</strong>
                ${t.mermas.map(m=>`<div style="margin:5px 0">‚Ä¢ ${m.insumo}: <strong>${m.cantidad}</strong></div>`).join('')}
            </div>
            `:'<p style="color:#999">Sin mermas</p>'}
            <p><strong>Lote L√≠quido:</strong> ${t.loteLiquido}</p>
            <p><strong>Pedido:</strong> ${t.pedido}</p>
            <p><strong>Cliente:</strong> ${t.cliente}</p>
            <p><strong>Responsable:</strong> ${t.responsable}</p>
            <button class="btn btn-eliminar" onclick="eliminarTrazabilidad('${t.id}')">üóëÔ∏è Eliminar</button>
        </div>
    `).join('');
}

function eliminarTrazabilidad(id){
    if(confirm('¬øEliminar este registro de trazabilidad?')){
        database.ref('trazabilidad/'+id).remove().then(()=>alert('‚úÖ Eliminado')).catch(err=>alert('Error: '+err.message));
    }
}

function descargarExcelTrazabilidad(){
    if(!trazabilidad || trazabilidad.length===0){
        alert('No hay datos de trazabilidad para exportar');
        return;
    }
    
    try {
        const wb=XLSX.utils.book_new();
        
        // HOJA 1: Trazabilidad General
        const d1=trazabilidad.map(t=>({
            'ID':t.id||'',
            'Fecha':t.fecha||'',
            'Hora':t.hora||'',
            'Presentaci√≥n':t.presentacion||'N/A',
            'Tipo':t.tipo||'',
            'Cajas Producidas PT':t.cajasProducidas||0,
            'Lote L√≠quido':t.loteLiquido||'',
            'Pedido':t.pedido||'',
            'Cliente':t.cliente||'',
            'Responsable':t.responsable||''
        }));
        const ws1=XLSX.utils.json_to_sheet(d1);
        ws1['!cols']=[{wch:15},{wch:12},{wch:8},{wch:12},{wch:12},{wch:18},{wch:15},{wch:15},{wch:25},{wch:20}];
        XLSX.utils.book_append_sheet(wb,ws1,'Trazabilidad');
        
        // HOJA 2: Insumos Consumidos
        const insumosDetallados=[];
        trazabilidad.forEach(t=>{
            if(t.insumosConsumidos && Array.isArray(t.insumosConsumidos) && t.insumosConsumidos.length>0){
                t.insumosConsumidos.forEach(ins=>{
                    insumosDetallados.push({
                        'ID Trazabilidad':t.id||'',
                        'Fecha':t.fecha||'',
                        'Presentaci√≥n':t.presentacion||'',
                        'Tipo':t.tipo||'',
                        'Insumo':ins.nombre||'',
                        'Cantidad Consumida':ins.cantidad||0,
                        'Lote L√≠quido':t.loteLiquido||'',
                        'Pedido':t.pedido||'',
                        'Cliente':t.cliente||''
                    });
                });
            }
        });
        
        if(insumosDetallados.length>0){
            const ws2=XLSX.utils.json_to_sheet(insumosDetallados);
            ws2['!cols']=[{wch:15},{wch:12},{wch:12},{wch:12},{wch:50},{wch:18},{wch:15},{wch:15},{wch:25}];
            XLSX.utils.book_append_sheet(wb,ws2,'Insumos Consumidos');
        }
        
        // HOJA 3: Mermas Detalladas
        const mermasDetalladas=[];
        trazabilidad.forEach(t=>{
            if(t.mermas && Array.isArray(t.mermas) && t.mermas.length>0){
                t.mermas.forEach(m=>{
                    mermasDetalladas.push({
                        'ID Trazabilidad':t.id||'',
                        'Fecha':t.fecha||'',
                        'Insumo':m.insumo||'',
                        'Cantidad Merma':m.cantidad||0,
                        'Lote L√≠quido':t.loteLiquido||'',
                        'Pedido':t.pedido||'',
                        'Cliente':t.cliente||''
                    });
                });
            }
        });
        
        if(mermasDetalladas.length>0){
            const ws3=XLSX.utils.json_to_sheet(mermasDetalladas);
            ws3['!cols']=[{wch:15},{wch:12},{wch:50},{wch:15},{wch:15},{wch:15},{wch:25}];
            XLSX.utils.book_append_sheet(wb,ws3,'Mermas');
        }
        
        XLSX.writeFile(wb,'Trazabilidad_'+new Date().toISOString().split('T')[0]+'.xlsx');
        console.log('Excel de trazabilidad descargado correctamente');
    } catch(error) {
        console.error('Error al generar Excel de trazabilidad:', error);
        alert('Error al generar el Excel. Por favor intenta de nuevo.');
    }
}

function mostrar(cual){if(!PERMISOS[currentUser.rol].includes(cual)){alert("‚ùå No tienes permisos");return;}
    document.querySelectorAll('.card').forEach(c=>c.classList.remove('active'));
    document.getElementById(cual+'Card').classList.add('active');
    if(cual==='materialista'){cargarInsumosEntrega();mostrarEntregas();}
    if(cual==='almacen')mostrarRecepciones();
    if(cual==='exportaciones')mostrarExportaciones();
    if(cual==='trazabilidad'){mostrarTrazabilidad();cargarInsumosMerma();limpiarFormularioTrazabilidad();}
    if(cual==='inventario'){mostrarInventario();actualizarResumenInventario();}
}

// ============================================================================
// NUEVO SISTEMA DE ENTREGAS DIRECTAS A PRODUCCI√ìN
// ============================================================================
let entregas=[];

function cargarInsumosEntrega(){
    const s=document.getElementById('insumoEntrega');
    s.innerHTML='<option value="">Selecciona...</option>';
    INSUMOS_MI_CAMPO.forEach((item,i)=>{
        const o=document.createElement('option');
        o.value=JSON.stringify(item);
        o.textContent=item.insumo+' - '+item.presentacion+' - '+item.tipo;
        s.appendChild(o);
    });
    document.getElementById('responsableEntrega').value=currentUser.nombre;
}

function registrarEntregaProduccion(){
    const insumoData=JSON.parse(document.getElementById('insumoEntrega').value);
    const insumoTexto=insumoData.insumo+' - '+insumoData.presentacion+' - '+insumoData.tipo;
    const cantidad=parseInt(document.getElementById('cantidadEntrega').value);
    
    const hoy=new Date();
    const dia=String(hoy.getDate()).padStart(2,'0');
    const mes=String(hoy.getMonth()+1).padStart(2,'0');
    const a√±o=hoy.getFullYear();
    const fechaStr=dia+mes+a√±o;
    const entregsHoy=entregas.filter(e=>e.id.startsWith('ENT'+fechaStr));
    const consecutivo=entregsHoy.length+1;
    const id=`ENT${fechaStr}-${consecutivo}`;
    
    const datos={
        id:id,
        insumo:insumoTexto,
        cantidad:cantidad,
        receptor:document.getElementById('receptorEntrega').value,
        notas:document.getElementById('notasEntrega').value||'',
        responsable:document.getElementById('responsableEntrega').value,
        fecha:hoy.toISOString()
    };
    
    // Guardar entrega Y actualizar inventario
    database.ref('entregas/'+id).set(datos).then(()=>{
        // ACTUALIZAR INVENTARIO: Restar de Almac√©n, Sumar a Producci√≥n
        actualizarInventarioEntrega(insumoTexto, cantidad).then(()=>{
            document.querySelector('#materialistaCard form').reset();
            document.getElementById('responsableEntrega').value=currentUser.nombre;
            alert('‚úÖ Entrega registrada: '+id+'\nüì¶ Inventario actualizado\n‚ûñ Almac√©n: -'+cantidad+'\n‚ûï Producci√≥n: +'+cantidad);
            mostrarEntregas();
        }).catch(err=>{
            console.error('Error al actualizar inventario:', err);
            alert('‚ö†Ô∏è Entrega guardada pero error al actualizar inventario: '+err.message);
        });
    });
}

function mostrarEntregas(){
    const lista=document.getElementById('listaEntregas');
    if(entregas.length===0){
        lista.innerHTML='<p style="color:#666">No hay entregas registradas</p>';
        return;
    }
    
    lista.innerHTML=entregas.sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).map(e=>`
        <div class="request-item">
            <h3>${e.id}</h3>
            <p><strong>Fecha:</strong> ${new Date(e.fecha).toLocaleString('es-MX')}</p>
            <p><strong>Insumo:</strong> ${e.insumo}</p>
            <p><strong>Cantidad:</strong> ${e.cantidad}</p>
            <p><strong>Entregado a:</strong> ${e.receptor}</p>
            <p><strong>Responsable:</strong> ${e.responsable}</p>
            ${e.notas?`<p><strong>Notas:</strong> ${e.notas}</p>`:''}
            <button class="btn btn-eliminar" onclick="eliminarEntrega('${e.id}')">üóëÔ∏è Eliminar</button>
        </div>
    `).join('');
}

function eliminarEntrega(id){
    if(!confirm('¬øEliminar entrega '+id+'?'))return;
    database.ref('entregas/'+id).remove().then(()=>{
        alert('‚úÖ Entrega eliminada');
        mostrarEntregas();
    });
}
// ============================================================================

// ============================================================================
// M√ìDULO DE INVENTARIO
// ============================================================================
let filtroInventario='';

function generarKeyInsumo(insumo,presentacion,tipo){
    const i=insumo.replace(/\s+/g,'-').toUpperCase();
    const p=presentacion.replace(/\s+/g,'-').replace(/\./g,'').toUpperCase();
    const t=tipo.replace(/\s+/g,'-').toUpperCase();
    return `${i}-${p}-${t}`;
}

function mostrarInventario(){
    const lista=document.getElementById('listaInventario');
    
    if(inventario.length===0){
        lista.innerHTML='<div style="background:#fef3c7;padding:20px;border-radius:8px;text-align:center"><h3>üì¶ No hay insumos en inventario</h3><p>Usa "Carga Inicial" para agregar los primeros insumos</p><button class="btn" onclick="mostrarFormularioCargaInicial()" style="background:#3b82f6;color:white;margin-top:10px">üì• Cargar Inventario Inicial</button></div>';
        return;
    }
    
    let invFiltrado=inventario;
    if(filtroInventario){
        const f=filtroInventario.toLowerCase();
        invFiltrado=inventario.filter(i=>i.nombre.toLowerCase().includes(f));
    }
    
    if(invFiltrado.length===0){
        lista.innerHTML='<p style="color:#666;text-align:center">No se encontraron insumos con ese criterio</p>';
        return;
    }
    
    lista.innerHTML=invFiltrado.sort((a,b)=>a.nombre.localeCompare(b.nombre)).map(item=>{
        const total=item.stockAlmacen+item.stockProduccion;
        const stockBajo=item.stockMinimo&&total<item.stockMinimo;
        
        return `
            <div class="request-item" style="${stockBajo?'border-left:4px solid #f59e0b;background:#fffbeb':''}">
                <h3>${item.nombre}</h3>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin:15px 0">
                    <div style="background:#e0f2fe;padding:12px;border-radius:6px">
                        <div style="font-size:12px;color:#666">üè¢ Almac√©n General</div>
                        <div style="font-size:24px;font-weight:bold;color:#3b82f6">${item.stockAlmacen.toLocaleString()}</div>
                    </div>
                    <div style="background:#fef3c7;padding:12px;border-radius:6px">
                        <div style="font-size:12px;color:#666">üè≠ Piso Producci√≥n</div>
                        <div style="font-size:24px;font-weight:bold;color:#f59e0b">${item.stockProduccion.toLocaleString()}</div>
                    </div>
                    <div style="background:#d1fae5;padding:12px;border-radius:6px">
                        <div style="font-size:12px;color:#666">üìä Total</div>
                        <div style="font-size:24px;font-weight:bold;color:#10b981">${total.toLocaleString()}</div>
                    </div>
                </div>
                ${item.stockMinimo?`<p style="margin:5px 0"><strong>Stock M√≠nimo:</strong> ${item.stockMinimo.toLocaleString()}</p>`:''}
                ${stockBajo?'<p style="color:#f59e0b;font-weight:bold;margin:10px 0">‚ö†Ô∏è STOCK BAJO - Reordenar</p>':''}
                <p style="font-size:12px;color:#999;margin:5px 0">√öltima actualizaci√≥n: ${item.ultimaActualizacion?new Date(item.ultimaActualizacion).toLocaleString('es-MX'):'N/A'}</p>
                <button class="btn" onclick="ajustarStockInsumo('${item.id}')" style="background:#f59e0b;color:white;margin-top:10px">üîÑ Ajustar</button>
            </div>
        `;
    }).join('');
}

function filtrarInventario(){
    filtroInventario=document.getElementById('buscarInsumo').value;
    mostrarInventario();
}

function actualizarResumenInventario(){
    const total=inventario.length;
    const bajos=inventario.filter(i=>{
        const t=i.stockAlmacen+i.stockProduccion;
        return i.stockMinimo&&t<i.stockMinimo;
    }).length;
    const ok=total-bajos;
    
    document.getElementById('totalInsumos').textContent=total;
    document.getElementById('insumosOK').textContent=ok;
    document.getElementById('insumosBajos').textContent=bajos;
}

function mostrarFormularioCargaInicial(){
    const modal=`
        <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999" id="modalCarga" onclick="if(event.target.id==='modalCarga')cerrarModal()">
            <div style="background:white;padding:30px;border-radius:12px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto" onclick="event.stopPropagation()">
                <h2>üì• Carga Inicial de Inventario</h2>
                <p style="color:#666">Ingresa el stock inicial de cada ubicaci√≥n</p>
                
                <div class="form-group">
                    <label>Insumo *</label>
                    <select id="insumoCI" required>
                        <option value="">Selecciona...</option>
                        ${INSUMOS_MI_CAMPO.map(i=>`<option value="${JSON.stringify(i).replace(/"/g,'&quot;')}">${i.insumo} - ${i.presentacion} - ${i.tipo}</option>`).join('')}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Stock en Almac√©n General *</label>
                    <input type="number" id="stockAlmacenCI" min="0" value="0" required>
                </div>
                
                <div class="form-group">
                    <label>Stock en Piso Producci√≥n *</label>
                    <input type="number" id="stockProduccionCI" min="0" value="0" required>
                </div>
                
                <div class="form-group">
                    <label>Stock M√≠nimo (Opcional)</label>
                    <input type="number" id="stockMinimoCI" min="0" value="0">
                </div>
                
                <div style="display:flex;gap:10px;margin-top:20px">
                    <button class="btn" onclick="guardarCargaInicial()" style="background:#10b981;color:white;flex:1">‚úÖ Guardar</button>
                    <button class="btn" onclick="cerrarModal()" style="background:#6b7280;color:white">‚ùå Cancelar</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend',modal);
}

function guardarCargaInicial(){
    const insumoData=JSON.parse(document.getElementById('insumoCI').value.replace(/&quot;/g,'"'));
    const stockAlmacen=parseInt(document.getElementById('stockAlmacenCI').value)||0;
    const stockProduccion=parseInt(document.getElementById('stockProduccionCI').value)||0;
    const stockMinimo=parseInt(document.getElementById('stockMinimoCI').value)||0;
    
    const nombre=`${insumoData.insumo} - ${insumoData.presentacion} - ${insumoData.tipo}`;
    const id=generarKeyInsumo(insumoData.insumo,insumoData.presentacion,insumoData.tipo);
    
    const datos={
        id:id,
        nombre:nombre,
        stockAlmacen:stockAlmacen,
        stockProduccion:stockProduccion,
        stockMinimo:stockMinimo,
        ultimaActualizacion:new Date().toISOString()
    };
    
    database.ref('inventario/'+id).set(datos).then(()=>{
        cerrarModal();
        alert('‚úÖ Insumo agregado al inventario');
    });
}

function mostrarFormularioAjuste(){
    if(inventario.length===0){
        alert('‚ö†Ô∏è Primero debes cargar el inventario inicial');
        return;
    }
    
    const modal=`
        <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999" id="modalAjuste" onclick="if(event.target.id==='modalAjuste')cerrarModal()">
            <div style="background:white;padding:30px;border-radius:12px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto" onclick="event.stopPropagation()">
                <h2>üîÑ Ajuste de Inventario</h2>
                <p style="color:#666">Corrige el stock despu√©s de un conteo f√≠sico</p>
                
                <div class="form-group">
                    <label>Insumo *</label>
                    <select id="insumoAjuste" required onchange="cargarStockActual()">
                        <option value="">Selecciona...</option>
                        ${inventario.map(i=>`<option value="${i.id}">${i.nombre}</option>`).join('')}
                    </select>
                </div>
                
                <div id="stockActualInfo" style="display:none;background:#e0f2fe;padding:15px;border-radius:8px;margin:15px 0">
                    <h4 style="margin:0 0 10px 0">Stock Actual en Sistema:</h4>
                    <p style="margin:5px 0">üè¢ Almac√©n: <strong id="saAlmacen">0</strong></p>
                    <p style="margin:5px 0">üè≠ Producci√≥n: <strong id="saProduccion">0</strong></p>
                </div>
                
                <div class="form-group">
                    <label>Ubicaci√≥n *</label>
                    <select id="ubicacionAjuste" required>
                        <option value="almacen">üè¢ Almac√©n General</option>
                        <option value="produccion">üè≠ Piso Producci√≥n</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Nuevo Stock (cantidad contada) *</label>
                    <input type="number" id="nuevoStock" min="0" value="0" required>
                </div>
                
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea id="obsAjuste" rows="2" placeholder="Ej: Conteo f√≠sico mensual"></textarea>
                </div>
                
                <div style="display:flex;gap:10px;margin-top:20px">
                    <button class="btn" onclick="guardarAjuste()" style="background:#10b981;color:white;flex:1">‚úÖ Ajustar</button>
                    <button class="btn" onclick="cerrarModal()" style="background:#6b7280;color:white">‚ùå Cancelar</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend',modal);
}

function ajustarStockInsumo(insumoId){
    mostrarFormularioAjuste();
    setTimeout(()=>{
        document.getElementById('insumoAjuste').value=insumoId;
        cargarStockActual();
    },100);
}

function cargarStockActual(){
    const id=document.getElementById('insumoAjuste').value;
    if(!id)return;
    
    const item=inventario.find(i=>i.id===id);
    if(!item)return;
    
    document.getElementById('saAlmacen').textContent=item.stockAlmacen.toLocaleString();
    document.getElementById('saProduccion').textContent=item.stockProduccion.toLocaleString();
    document.getElementById('stockActualInfo').style.display='block';
}

function guardarAjuste(){
    const id=document.getElementById('insumoAjuste').value;
    const ubicacion=document.getElementById('ubicacionAjuste').value;
    const nuevoStock=parseInt(document.getElementById('nuevoStock').value);
    
    const item=inventario.find(i=>i.id===id);
    if(!item)return;
    
    const campo=ubicacion==='almacen'?'stockAlmacen':'stockProduccion';
    const stockAnterior=item[campo];
    const diferencia=nuevoStock-stockAnterior;
    
    if(!confirm(`¬øAjustar ${item.nombre}?\n\nStock anterior: ${stockAnterior}\nNuevo stock: ${nuevoStock}\nDiferencia: ${diferencia>0?'+':''} ${diferencia}`))return;
    
    const updates={};
    updates[campo]=nuevoStock;
    updates['ultimaActualizacion']=new Date().toISOString();
    
    database.ref('inventario/'+id).update(updates).then(()=>{
        cerrarModal();
        alert('‚úÖ Stock ajustado correctamente');
    });
}

function cerrarModal(){
    const modales=document.querySelectorAll('[id^="modal"]');
    modales.forEach(m=>m.remove());
}

// ============================================================================
// KARDEX - HISTORIAL DE MOVIMIENTOS
// ============================================================================
function mostrarKardex(){
    const modal=`
        <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px" id="modalKardex" onclick="if(event.target.id==='modalKardex')cerrarModal()">
            <div style="background:white;padding:30px;border-radius:12px;max-width:1200px;width:100%;max-height:90vh;overflow-y:auto" onclick="event.stopPropagation()">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                    <h2 style="margin:0">üìù Kardex - Historial de Movimientos</h2>
                    <button onclick="cerrarModal()" style="background:#6b7280;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer">‚úï Cerrar</button>
                </div>
                
                <div style="background:#e0f2fe;padding:15px;border-radius:8px;margin-bottom:20px">
                    <p style="margin:0;color:#666;font-size:14px">üìä El Kardex muestra todos los movimientos de inventario: recepciones, entregas a producci√≥n, consumo en producci√≥n, mermas y ajustes manuales.</p>
                </div>
                
                <div style="margin-bottom:20px">
                    <select id="filtroInsumoKardex" onchange="actualizarKardex()" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px">
                        <option value="">üì¶ Todos los insumos</option>
                        ${inventario.map(i=>`<option value="${i.nombre}">${i.nombre}</option>`).join('')}
                    </select>
                </div>
                
                <div id="listaKardex"></div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend',modal);
    actualizarKardex();
}

function actualizarKardex(){
    const filtro=document.getElementById('filtroInsumoKardex')?.value||'';
    const lista=document.getElementById('listaKardex');
    
    if(!lista)return;
    
    // Recolectar todos los movimientos
    let movimientos=[];
    
    // RECEPCIONES (Entradas a Almac√©n)
    recepciones.forEach(r=>{
        movimientos.push({
            fecha:r.fecha,
            tipo:'ENTRADA',
            insumo:r.insumo,
            cantidad:r.cantidad,
            detalle:`Recepci√≥n - Factura: ${r.factura} - Proveedor: ${r.proveedor}`,
            responsable:r.responsable,
            icono:'üì•',
            color:'#10b981'
        });
    });
    
    // ENTREGAS A PRODUCCI√ìN (Salida de Almac√©n, Entrada a Producci√≥n)
    entregas.forEach(e=>{
        movimientos.push({
            fecha:e.fecha,
            tipo:'ENTREGA_PRODUCCION',
            insumo:e.insumo,
            cantidad:e.cantidad,
            detalle:`Entrega a Producci√≥n - Receptor: ${e.receptor}${e.notas?' - '+e.notas:''}`,
            responsable:e.responsable,
            icono:'üì¶',
            color:'#8b5cf6'
        });
    });
    
    // CONSUMO EN PRODUCCI√ìN (Descuento de Producci√≥n)
    trazabilidad.forEach(t=>{
        if(t.insumosConsumidos && t.insumosConsumidos.length>0){
            t.insumosConsumidos.forEach(ins=>{
                movimientos.push({
                    fecha:t.timestamp||t.fecha,
                    tipo:'CONSUMO_PRODUCCION',
                    insumo:ins.nombre,
                    cantidad:ins.cantidad,
                    detalle:`Consumo en Producci√≥n - ${t.presentacion} ${t.tipo} - ${t.cajasProducidas} cajas - Pedido: ${t.pedido}`,
                    responsable:t.responsable,
                    icono:'üè≠',
                    color:'#f59e0b'
                });
            });
        }
    });
    
    // MERMAS (Descuento de Producci√≥n)
    trazabilidad.forEach(t=>{
        if(t.mermas && t.mermas.length>0){
            t.mermas.forEach(m=>{
                movimientos.push({
                    fecha:t.timestamp||t.fecha,
                    tipo:'MERMA',
                    insumo:m.insumo,
                    cantidad:m.cantidad,
                    detalle:`Merma - Pedido: ${t.pedido} - Cliente: ${t.cliente}`,
                    responsable:t.responsable,
                    icono:'‚ö†Ô∏è',
                    color:'#ef4444'
                });
            });
        }
    });
    
    // Filtrar por insumo si hay filtro
    if(filtro){
        movimientos=movimientos.filter(m=>m.insumo===filtro);
    }
    
    // Ordenar por fecha descendente
    movimientos.sort((a,b)=>new Date(b.fecha)-new Date(a.fecha));
    
    if(movimientos.length===0){
        lista.innerHTML='<p style="text-align:center;color:#666;padding:40px">No hay movimientos registrados</p>';
        return;
    }
    
    // Calcular saldo acumulado (solo si hay filtro)
    if(filtro){
        const insumoInv=inventario.find(i=>i.nombre===filtro);
        let saldoActual=(insumoInv?.stockAlmacen||0)+(insumoInv?.stockProduccion||0);
        
        // Recorrer movimientos de m√°s reciente a m√°s antiguo para calcular saldo
        for(let i=0;i<movimientos.length;i++){
            movimientos[i].saldo=saldoActual;
            
            // Restar para obtener saldo anterior
            if(movimientos[i].tipo==='ENTRADA'){
                saldoActual-=movimientos[i].cantidad;
            }else{
                saldoActual+=movimientos[i].cantidad;
            }
        }
        
        // Invertir para mostrar de m√°s antiguo a m√°s reciente
        movimientos.reverse();
    }
    
    lista.innerHTML=`
        <div style="background:#f9fafb;border-radius:8px;overflow:hidden">
            <div style="display:grid;grid-template-columns:120px 100px 2fr 100px ${filtro?'120px':''} 150px;gap:10px;padding:12px;background:#e5e7eb;font-weight:bold;font-size:14px">
                <div>Fecha</div>
                <div>Tipo</div>
                <div>Detalle</div>
                <div style="text-align:right">Cantidad</div>
                ${filtro?'<div style="text-align:right">Saldo</div>':''}
                <div>Responsable</div>
            </div>
            ${movimientos.map(m=>`
                <div style="display:grid;grid-template-columns:120px 100px 2fr 100px ${filtro?'120px':''} 150px;gap:10px;padding:12px;border-bottom:1px solid #e5e7eb;align-items:center">
                    <div style="font-size:12px;color:#666">${new Date(m.fecha).toLocaleDateString('es-MX')}</div>
                    <div style="font-size:12px;padding:4px 8px;border-radius:4px;background:${m.color};color:white;text-align:center">${m.icono}</div>
                    <div style="font-size:13px">
                        <div style="font-weight:bold">${m.insumo}</div>
                        <div style="color:#666;font-size:12px">${m.detalle}</div>
                    </div>
                    <div style="text-align:right;font-weight:bold;color:${m.tipo==='ENTRADA'?'#10b981':'#ef4444'}">${m.tipo==='ENTRADA'?'+':'-'}${m.cantidad.toLocaleString()}</div>
                    ${filtro?`<div style="text-align:right;font-weight:bold;color:#3b82f6">${m.saldo.toLocaleString()}</div>`:''}
                    <div style="font-size:12px;color:#666">${m.responsable||'N/A'}</div>
                </div>
            `).join('')}
        </div>
        
        <div style="margin-top:20px;padding:15px;background:#e0f2fe;border-radius:8px">
            <h4 style="margin:0 0 10px 0">üìä Resumen</h4>
            <p style="margin:5px 0"><strong>Total movimientos:</strong> ${movimientos.length}</p>
            ${filtro?`<p style="margin:5px 0"><strong>Saldo actual:</strong> ${movimientos[movimientos.length-1]?.saldo.toLocaleString()||0} unidades</p>`:''}
        </div>
    `;
}
// ============================================================================

// ============================================================================
// FUNCIONES DE ACTUALIZACI√ìN AUTOM√ÅTICA DE INVENTARIO
// ============================================================================

// 1. RECEPCIONES: Sumar a Stock Almac√©n
function actualizarInventarioRecepcion(nombreInsumo, cantidad){
    return new Promise((resolve, reject)=>{
        const insumoId=generarIdDesdeNombre(nombreInsumo);
        const refInsumo=database.ref('inventario/'+insumoId);
        
        refInsumo.once('value').then(snapshot=>{
            const insumo=snapshot.val();
            
            if(!insumo){
                // Si el insumo no existe en inventario, crearlo
                const nuevoInsumo={
                    id:insumoId,
                    nombre:nombreInsumo,
                    stockAlmacen:cantidad,
                    stockProduccion:0,
                    stockMinimo:0,
                    ultimaActualizacion:new Date().toISOString()
                };
                return refInsumo.set(nuevoInsumo);
            }else{
                // Si existe, sumar a stock almac√©n
                return refInsumo.update({
                    stockAlmacen:(insumo.stockAlmacen||0)+cantidad,
                    ultimaActualizacion:new Date().toISOString()
                });
            }
        }).then(()=>resolve())
        .catch(err=>reject(err));
    });
}

// 2. ENTREGAS: Restar de Almac√©n, Sumar a Producci√≥n
function actualizarInventarioEntrega(nombreInsumo, cantidad){
    return new Promise((resolve, reject)=>{
        const insumoId=generarIdDesdeNombre(nombreInsumo);
        const refInsumo=database.ref('inventario/'+insumoId);
        
        refInsumo.once('value').then(snapshot=>{
            const insumo=snapshot.val();
            
            if(!insumo){
                reject(new Error('‚ö†Ô∏è Insumo no existe en inventario. Primero debes cargarlo.'));
                return;
            }
            
            const nuevoStockAlmacen=(insumo.stockAlmacen||0)-cantidad;
            if(nuevoStockAlmacen<0){
                reject(new Error('‚ö†Ô∏è Stock insuficiente en Almac√©n. Disponible: '+insumo.stockAlmacen));
                return;
            }
            
            return refInsumo.update({
                stockAlmacen:nuevoStockAlmacen,
                stockProduccion:(insumo.stockProduccion||0)+cantidad,
                ultimaActualizacion:new Date().toISOString()
            });
        }).then(()=>resolve())
        .catch(err=>reject(err));
    });
}

// 3. TRAZABILIDAD: Restar insumos consumidos y mermas de Producci√≥n
function actualizarInventarioTrazabilidad(insumosConsumidos, mermas){
    const promesas=[];
    
    // Descontar insumos consumidos
    insumosConsumidos.forEach(ins=>{
        const promesa=new Promise((resolve, reject)=>{
            const insumoId=generarIdDesdeNombre(ins.nombre);
            const refInsumo=database.ref('inventario/'+insumoId);
            
            refInsumo.once('value').then(snapshot=>{
                const insumo=snapshot.val();
                
                if(!insumo){
                    console.warn('Insumo no existe en inventario:', ins.nombre);
                    resolve(); // No fallar, solo advertir
                    return;
                }
                
                const nuevoStockProduccion=(insumo.stockProduccion||0)-ins.cantidad;
                
                return refInsumo.update({
                    stockProduccion:Math.max(0, nuevoStockProduccion),
                    ultimaActualizacion:new Date().toISOString()
                });
            }).then(()=>resolve())
            .catch(err=>reject(err));
        });
        promesas.push(promesa);
    });
    
    // Descontar mermas
    mermas.forEach(m=>{
        const promesa=new Promise((resolve, reject)=>{
            const insumoId=generarIdDesdeNombre(m.insumo);
            const refInsumo=database.ref('inventario/'+insumoId);
            
            refInsumo.once('value').then(snapshot=>{
                const insumo=snapshot.val();
                
                if(!insumo){
                    console.warn('Insumo no existe en inventario:', m.insumo);
                    resolve();
                    return;
                }
                
                const nuevoStockProduccion=(insumo.stockProduccion||0)-m.cantidad;
                
                return refInsumo.update({
                    stockProduccion:Math.max(0, nuevoStockProduccion),
                    ultimaActualizacion:new Date().toISOString()
                });
            }).then(()=>resolve())
            .catch(err=>reject(err));
        });
        promesas.push(promesa);
    });
    
    return Promise.all(promesas);
}

// Helper: Generar ID desde nombre completo
function generarIdDesdeNombre(nombreCompleto){
    // "BOTELLA - 750 ml - GENERAL" -> "BOTELLA-750ML-GENERAL"
    return nombreCompleto
        .toUpperCase()
        .replace(/\s+/g,'-')
        .replace(/\./g,'')
        .replace(/-+/g,'-');
}
// ============================================================================


function descargarExcelInventario(){
    if(inventario.length===0){
        alert('‚ö†Ô∏è No hay datos de inventario');
        return;
    }
    
    const wb=XLSX.utils.book_new();
    const datos=inventario.map(i=>({
        'Insumo':i.nombre,
        'Stock Almac√©n':i.stockAlmacen,
        'Stock Producci√≥n':i.stockProduccion,
        'Stock Total':i.stockAlmacen+i.stockProduccion,
        'Stock M√≠nimo':i.stockMinimo||0,
        'Estado':i.stockMinimo&&(i.stockAlmacen+i.stockProduccion)<i.stockMinimo?'‚ö†Ô∏è BAJO':'‚úÖ OK',
        '√öltima Actualizaci√≥n':i.ultimaActualizacion?new Date(i.ultimaActualizacion).toLocaleString('es-MX'):'N/A'
    }));
    
    const ws=XLSX.utils.json_to_sheet(datos);
    ws['!cols']=[{wch:40},{wch:15},{wch:15},{wch:15},{wch:15},{wch:10},{wch:20}];
    XLSX.utils.book_append_sheet(wb,ws,'Inventario');
    
    XLSX.writeFile(wb,'Inventario_'+new Date().toISOString().split('T')[0]+'.xlsx');
}
// ============================================================================


// ============================================================================
// FUNCIONES OBSOLETAS - PRODUCCI√ìN ELIMINADA
// ============================================================================
/*
function crearRequisicion(){
    const idx=document.getElementById('insumo').value;
    const ins=currentInsumos[idx];
    
    // Generar ID con formato: REQ25012026-1
    const hoy = new Date();
    const dia = String(hoy.getDate()).padStart(2, '0');
    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
    const a√±o = hoy.getFullYear();
    const fechaStr = dia + mes + a√±o;
    
    // Encontrar el consecutivo del d√≠a
    const reqsHoy = solicitudes.filter(r => r.id.startsWith('REQ' + fechaStr));
    const consecutivo = reqsHoy.length + 1;
    const id = `REQ${fechaStr}-${consecutivo}`;
    
    database.ref('requests/'+id).set({
        id:id,
        cliente:currentClient,
        insumo:ins.insumo+' - '+ins.presentacion+' - '+ins.tipo,
        cantidad:parseInt(document.getElementById('cantidad').value),
        solicitante:document.getElementById('solicitante').value,
        notas:document.getElementById('notas').value,
        fecha:new Date().toISOString(),
        status:'pending',
        parcialidades:[],
        cantidadEntregadaTotal:0
    }).then(()=>{
        document.querySelector('#produccionCard form').reset();
        cargarInsumos();
        alert('‚úÖ Requisici√≥n creada: '+id);
    });
}
*/
// ============================================================================

function filtrarSolicitudes(f){
    filtroActual=f;
    mostrarSolicitudes();
}

function mostrarSolicitudes(){
    const lista=document.getElementById('listaSolicitudes');
    let filtradas=solicitudes;
    if(filtroActual!=='all')filtradas=solicitudes.filter(r=>r.status===filtroActual);
    if(filtradas.length===0){lista.innerHTML='<p>No hay solicitudes</p>';return;}
    
    lista.innerHTML=filtradas.map(req=>{
        const entregado=req.cantidadEntregadaTotal||0;
        const faltante=req.cantidad-entregado;
        const excedente=entregado>req.cantidad?entregado-req.cantidad:0;
        const parcialidades=req.parcialidades||[];
        let estadoTexto='Pendiente';
        if(req.status==='approved')estadoTexto='Aprobada';
        else if(req.status==='partial')estadoTexto='Parcial';
        else if(req.status==='delivered')estadoTexto='Entregada';
        else if(req.status==='excedente')estadoTexto='Excedente pendiente';
        
        return `
            <div class="request-item ${req.status==='excedente'?'excedente':''}">
                <h3>${req.id}</h3>
                <p><strong>Cliente:</strong> ${req.cliente}</p>
                <p><strong>Insumo:</strong> ${req.insumo}</p>
                <p><strong>Cantidad Solicitada:</strong> ${req.cantidad}</p>
                <p><strong>Cantidad Entregada:</strong> ${entregado}</p>
                ${faltante>0?`<p class="faltante">‚ö†Ô∏è <strong>Faltante:</strong> ${faltante}</p>`:''}
                ${excedente>0?`<p style="color:#f59e0b;font-weight:bold">‚ö†Ô∏è <strong>Excedente:</strong> ${excedente} (Pendiente autorizaci√≥n)</p>`:''}
                <p><strong>Solicitante:</strong> ${req.solicitante}</p>
                ${req.materialista?`<p><strong>Materialista:</strong> ${req.materialista}</p>`:''}
                <p><strong>Estado:</strong> <span class="status-${req.status}">${estadoTexto}</span></p>
                
                ${parcialidades.length>0?`
                    <div style="margin-top:10px">
                        <strong>üì¶ Parcialidades (${parcialidades.length}):</strong>
                        ${parcialidades.map((p,i)=>`
                            <div class="parcialidad-item">
                                #${i+1}: <strong>${p.cantidad}</strong> unidades - ${p.receptor} (${new Date(p.fecha).toLocaleDateString('es-MX')})
                            </div>
                        `).join('')}
                    </div>
                `:''}
                
                <div style="margin-top:15px">
                    ${req.status==='pending'?`<button class="btn btn-approve" onclick="aprobar('${req.id}')">Aprobar</button>`:''}
                    ${req.status==='approved'||req.status==='partial'?`
                        <button class="btn btn-deliver" onclick="entregarCompleto('${req.id}',${req.cantidad})">Entregar Todo</button>
                        <button class="btn btn-parcialidad" onclick="agregarParcialidad('${req.id}',${req.cantidad})">Agregar Parcialidad</button>
                    `:''}
                </div>
                
                <button class="btn btn-eliminar" onclick="eliminarSolicitud('${req.id}')">üóëÔ∏è Eliminar Solicitud</button>
            </div>
        `;
    }).join('');
}

function mostrarExcedentes(){
    const div=document.getElementById('solicitudesExcedente');
    if(!currentUser){return;}
    
    // Filtrar solo excedentes del usuario actual
    const excedentes=solicitudes.filter(r=>r.status==='excedente' && r.solicitante===currentUser.nombre);
    
    if(excedentes.length===0){
        div.innerHTML='<p style="color:#666">No hay excedentes pendientes de autorizaci√≥n</p>';
        return;
    }
    
    div.innerHTML=excedentes.map(req=>{
        const excedente=(req.cantidadEntregadaTotal||0)-req.cantidad;
        return `
            <div class="excedente-warning">
                <h4>‚ö†Ô∏è Excedente en ${req.id}</h4>
                <p><strong>Insumo:</strong> ${req.insumo}</p>
                <p><strong>Solicitado:</strong> ${req.cantidad}</p>
                <p><strong>Entregado:</strong> ${req.cantidadEntregadaTotal}</p>
                <p style="color:#f59e0b;font-weight:bold"><strong>Excedente:</strong> ${excedente} unidades</p>
                <div style="margin-top:10px">
                    <button class="btn btn-autorizar" onclick="autorizarExcedente('${req.id}')">‚úÖ Autorizar Excedente</button>
                    <button class="btn btn-rechazar" onclick="rechazarExcedente('${req.id}')">‚ùå Rechazar</button>
                </div>
            </div>
        `;
    }).join('');
}

let filtroProduccion='all';

function filtrarSolicitudesProduccion(filtro){
    filtroProduccion=filtro;
    mostrarSolicitudesProduccion();
}

function mostrarSolicitudesProduccion(){
    const lista=document.getElementById('listaSolicitudesProduccion');
    if(!currentUser){return;}
    
    // Filtrar solo las solicitudes del usuario actual
    let misSolicitudes=solicitudes.filter(r=>r.solicitante===currentUser.nombre);
    
    // Aplicar filtro de estado
    if(filtroProduccion!=='all'){
        misSolicitudes=misSolicitudes.filter(r=>r.status===filtroProduccion);
    }
    
    if(misSolicitudes.length===0){
        lista.innerHTML='<p style="color:#666">No hay solicitudes</p>';
        return;
    }
    
    lista.innerHTML=misSolicitudes.map(req=>{
        const entregado=req.cantidadEntregadaTotal||0;
        const faltante=req.cantidad-entregado;
        const excedente=entregado>req.cantidad?entregado-req.cantidad:0;
        const parcialidades=req.parcialidades||[];
        let estadoTexto='Pendiente';
        if(req.status==='approved')estadoTexto='Aprobada';
        else if(req.status==='partial')estadoTexto='Parcial';
        else if(req.status==='pendiente_confirmacion')estadoTexto='Pendiente Confirmaci√≥n';
        else if(req.status==='delivered')estadoTexto='Entregada';
        else if(req.status==='excedente')estadoTexto='Excedente pendiente';
        
        return `
            <div class="request-item ${req.status==='excedente'?'excedente':req.status==='pendiente_confirmacion'?'pendiente-conf':''}">
                <h3>${req.id}</h3>
                <p><strong>Cliente:</strong> ${req.cliente}</p>
                <p><strong>Insumo:</strong> ${req.insumo}</p>
                <p><strong>Cantidad Solicitada:</strong> ${req.cantidad}</p>
                <p><strong>Cantidad Entregada:</strong> ${entregado}</p>
                ${faltante>0 && req.status!=='pendiente_confirmacion'?`<p class="faltante">‚ö†Ô∏è <strong>Faltante:</strong> ${faltante}</p>`:''}
                ${excedente>0?`<p style="color:#f59e0b;font-weight:bold">‚ö†Ô∏è <strong>Excedente:</strong> ${excedente} (Pendiente autorizaci√≥n)</p>`:''}
                ${req.materialista?`<p><strong>Materialista:</strong> ${req.materialista}</p>`:''}
                <p><strong>Estado:</strong> <span class="status-${req.status}">${estadoTexto}</span></p>
                
                ${parcialidades.length>0?`
                    <div style="margin-top:10px">
                        <strong>üì¶ Parcialidades (${parcialidades.length}):</strong>
                        ${parcialidades.map((p,i)=>`
                            <div class="parcialidad-item">
                                #${i+1}: <strong>${p.cantidad}</strong> unidades - ${p.receptor} (${new Date(p.fecha).toLocaleDateString('es-MX')})
                            </div>
                        `).join('')}
                    </div>
                `:''}
                
                ${req.status==='excedente'?`
                    <div style="margin-top:15px">
                        <button class="btn btn-autorizar" onclick="autorizarExcedente('${req.id}')">‚úÖ Autorizar Excedente</button>
                        <button class="btn btn-rechazar" onclick="rechazarExcedente('${req.id}')">‚ùå Rechazar</button>
                    </div>
                `:''}
                
                ${req.status==='pendiente_confirmacion'?`
                    <div style="margin-top:15px;background:#e0f2fe;padding:15px;border-radius:8px;border:2px solid#0ea5e9">
                        <p style="margin:0 0 10px 0;color:#0c4a6e;font-weight:bold">‚úã Materialista ha entregado los materiales. Por favor confirma que los recibiste correctamente.</p>
                        <button class="btn btn-autorizar" onclick="confirmarRecepcion('${req.id}')">‚úÖ Confirmar Recepci√≥n</button>
                    </div>
                `:''}
                
                ${req.status==='delivered' && req.confirmadoPor?`
                    <p style="color:#10b981;font-weight:bold;margin-top:10px">‚úÖ Confirmado por: ${req.confirmadoPor} (${new Date(req.fechaConfirmacion).toLocaleString('es-MX')})</p>
                `:''}
            </div>
        `;
    }).join('');
}

function mostrarRecepciones(){
    const lista=document.getElementById('listaRecepciones');
    if(recepciones.length===0){
        lista.innerHTML='<p style="color:#666">No hay recepciones registradas</p>';
        return;
    }
    
    lista.innerHTML=recepciones.sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).map(rec=>`
        <div class="request-item">
            <h3>${rec.id}</h3>
            <p><strong>Fecha:</strong> ${new Date(rec.fecha).toLocaleString('es-MX')}</p>
            <p><strong>Factura:</strong> ${rec.factura}</p>
            <p><strong>Proveedor:</strong> ${rec.proveedor}</p>
            <p><strong>Insumo:</strong> ${rec.insumo}</p>
            <p><strong>Cantidad:</strong> ${rec.cantidad.toLocaleString()}</p>
            <p><strong>Responsable:</strong> ${rec.responsable}</p>
            <button class="btn btn-eliminar" onclick="eliminarRecepcion('${rec.id}')">üóëÔ∏è Eliminar</button>
        </div>
    `).join('');
}

function mostrarExportaciones(){
    const lista=document.getElementById('listaExportaciones');
    if(exportaciones.length===0){
        lista.innerHTML='<p style="color:#666">No hay exportaciones registradas</p>';
        return;
    }
    
    lista.innerHTML=exportaciones.sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).map(exp=>`
        <div class="request-item">
            <h3>${exp.id}</h3>
            <p><strong>Fecha:</strong> ${new Date(exp.fecha).toLocaleString('es-MX')}</p>
            <p><strong>Pedido:</strong> ${exp.pedido}</p>
            <p><strong>Presentaci√≥n:</strong> ${exp.presentacion}</p>
            <p><strong>Tipo:</strong> ${exp.tipo}</p>
            <p><strong>Cantidad Pallets:</strong> ${exp.cantidadPallets||'N/A'}</p>
            <p><strong>Cantidad Cajas:</strong> ${exp.cantidadCajas||'N/A'}</p>
            <p><strong>Cliente:</strong> ${exp.cliente}</p>
            <p><strong>Transporte:</strong> ${exp.transporte}</p>
            <p><strong>N√∫mero de Candado:</strong> ${exp.numeroCandado||'N/A'}</p>
            <p><strong>Operador:</strong> ${exp.operador||'N/A'}</p>
            <p><strong>Custodia:</strong> ${exp.custodia||'N/A'}</p>
            <p><strong>Responsable:</strong> ${exp.responsable}</p>
            <button class="btn btn-eliminar" onclick="eliminarExportacion('${exp.id}')">üóëÔ∏è Eliminar</button>
        </div>
    `).join('');
}

function actualizarEstadisticas(){
    // Solicitudes
    const pendientes = solicitudes.filter(r => r.status === 'pending').length;
    const proceso = solicitudes.filter(r => r.status === 'approved' || r.status === 'partial' || r.status === 'pendiente_confirmacion').length;
    const entregadas = solicitudes.filter(r => r.status === 'delivered').length;
    
    // Recepciones y Exportaciones de hoy
    const hoy = new Date();
    const diaHoy = hoy.getDate();
    const mesHoy = hoy.getMonth();
    const a√±oHoy = hoy.getFullYear();
    
    const recepcionesHoy = recepciones.filter(r => {
        const fechaRec = new Date(r.fecha);
        return fechaRec.getDate() === diaHoy && fechaRec.getMonth() === mesHoy && fechaRec.getFullYear() === a√±oHoy;
    }).length;
    
    const exportacionesHoy = exportaciones.filter(e => {
        const fechaExp = new Date(e.fecha);
        return fechaExp.getDate() === diaHoy && fechaExp.getMonth() === mesHoy && fechaExp.getFullYear() === a√±oHoy;
    }).length;
    
    // Actualizar DOM
    document.getElementById('statPendientes').textContent = pendientes;
    document.getElementById('statProceso').textContent = proceso;
    document.getElementById('statEntregadas').textContent = entregadas;
    document.getElementById('statRecepciones').textContent = recepcionesHoy;
    document.getElementById('statExportaciones').textContent = exportacionesHoy;
}

function aprobar(id){
    const materialista=currentUser.nombre;
    if(!materialista)return;
    database.ref('requests/'+id).update({
        status:'approved',
        materialista:materialista,
        fechaAprobacion:new Date().toISOString()
    }).then(()=>alert('‚úÖ Aprobada'));
}

function entregarCompleto(id,cantidadSolicitada){
    const cantidad=parseInt(prompt(`Cantidad a entregar (Solicitado: ${cantidadSolicitada}):`));
    if(!cantidad||cantidad<=0){alert('Cantidad inv√°lida');return;}
    
    const receptor=prompt('¬øQui√©n recibe? (nombre del receptor en producci√≥n)');
    if(!receptor)return;
    
    const req=solicitudes.find(r=>r.id===id);
    const p=req.parcialidades||[];
    const total=(req.cantidadEntregadaTotal||0)+cantidad;
    
    p.push({cantidad:cantidad,receptor:receptor,fecha:new Date().toISOString()});
    
    // Si entrega M√ÅS de lo solicitado
    if(total>req.cantidad){
        database.ref('requests/'+id).update({
            status:'excedente',
            parcialidades:p,
            cantidadEntregadaTotal:total
        }).then(()=>alert('‚ö†Ô∏è Excedente detectado. El solicitante debe autorizar.'));
    } else {
        // SIEMPRE pendiente de confirmaci√≥n (parcial o completa)
        database.ref('requests/'+id).update({
            status:'pendiente_confirmacion',
            parcialidades:p,
            cantidadEntregadaTotal:total
        }).then(()=>alert('‚úÖ Entrega registrada. Pendiente de confirmaci√≥n por Producci√≥n.'));
    }
}

function agregarParcialidad(id,cantidadSolicitada){
    const cantidad=parseInt(prompt(`Cantidad a entregar (Solicitado: ${cantidadSolicitada}):`));
    if(!cantidad||cantidad<=0){alert('Cantidad inv√°lida');return;}
    
    const receptor=prompt('¬øQui√©n recibe? (nombre del receptor en producci√≥n)');
    if(!receptor)return;
    
    const req=solicitudes.find(r=>r.id===id);
    const p=req.parcialidades||[];
    const total=(req.cantidadEntregadaTotal||0)+cantidad;
    
    p.push({cantidad:cantidad,receptor:receptor,fecha:new Date().toISOString()});
    
    // Si entrega M√ÅS de lo solicitado
    if(total>req.cantidad){
        database.ref('requests/'+id).update({
            status:'excedente',
            parcialidades:p,
            cantidadEntregadaTotal:total
        }).then(()=>alert('‚ö†Ô∏è Excedente detectado. El solicitante debe autorizar.'));
    } else {
        // SIEMPRE pendiente de confirmaci√≥n
        database.ref('requests/'+id).update({
            status:'pendiente_confirmacion',
            parcialidades:p,
            cantidadEntregadaTotal:total
        }).then(()=>alert('‚úÖ Parcialidad registrada. Pendiente de confirmaci√≥n por Producci√≥n.'));
    }
}

function autorizarExcedente(id){
    const req=solicitudes.find(r=>r.id===id);
    if(confirm(`¬øAutorizar el excedente?\n\nSolicitado: ${req.cantidad}\nEntregado: ${req.cantidadEntregadaTotal}\nExcedente: ${req.cantidadEntregadaTotal-req.cantidad}\n\nSe actualizar√° la cantidad solicitada.`)){
        database.ref('requests/'+id).update({
            cantidad:req.cantidadEntregadaTotal,
            status:'delivered'
        }).then(()=>alert('‚úÖ Excedente autorizado. Cantidad actualizada.'));
    }
}

function rechazarExcedente(id){
    const req=solicitudes.find(r=>r.id===id);
    const excedente=req.cantidadEntregadaTotal-req.cantidad;
    
    if(confirm(`¬øRechazar el excedente de ${excedente} unidades?\n\nSe revertir√° la √∫ltima entrega.`)){
        const p=req.parcialidades||[];
        const ultimaParcialidad=p[p.length-1];
        
        // Revertir √∫ltima parcialidad
        p.pop();
        const nuevoTotal=req.cantidadEntregadaTotal-ultimaParcialidad.cantidad;
        const status=nuevoTotal>=req.cantidad?'pendiente_confirmacion':nuevoTotal>0?'partial':'approved';
        
        database.ref('requests/'+id).update({
            status:status,
            parcialidades:p,
            cantidadEntregadaTotal:nuevoTotal
        }).then(()=>alert('‚ùå Excedente rechazado. Entrega revertida.'));
    }
}

function confirmarRecepcion(id){
    if(confirm('¬øConfirmar que recibiste todos los materiales correctamente?')){
        database.ref('requests/'+id).update({
            status:'delivered',
            fechaConfirmacion:new Date().toISOString(),
            confirmadoPor:currentUser.nombre
        }).then(()=>alert('‚úÖ Recepci√≥n confirmada. Solicitud completada.'));
    }
}

function eliminarSolicitud(id){
    if(confirm('¬øSeguro que quieres eliminar esta solicitud?\n\nID: '+id+'\n\nEsta acci√≥n no se puede deshacer.')){
        database.ref('requests/'+id).remove()
            .then(()=>alert('‚úÖ Solicitud eliminada'))
            .catch(()=>alert('‚ùå Error al eliminar'));
    }
}

function eliminarRecepcion(id){
    if(confirm('¬øSeguro que quieres eliminar esta recepci√≥n?\n\nID: '+id+'\n\nEsta acci√≥n no se puede deshacer.')){
        database.ref('recepciones/'+id).remove()
            .then(()=>alert('‚úÖ Recepci√≥n eliminada'))
            .catch(()=>alert('‚ùå Error al eliminar'));
    }
}

function eliminarExportacion(id){
    if(confirm('¬øSeguro que quieres eliminar esta exportaci√≥n?\n\nID: '+id+'\n\nEsta acci√≥n no se puede deshacer.')){
        database.ref('exportaciones/'+id).remove()
            .then(()=>alert('‚úÖ Exportaci√≥n eliminada'))
            .catch(()=>alert('‚ùå Error al eliminar'));
    }
}

function registrarRecepcion(){
    console.log('registrarRecepcion llamada');
    
    // Generar ID con formato: REC25012026-1
    const hoy = new Date();
    const dia = String(hoy.getDate()).padStart(2, '0');
    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
    const a√±o = hoy.getFullYear();
    const fechaStr = dia + mes + a√±o;
    
    // Encontrar el consecutivo del d√≠a
    const recsHoy = recepciones.filter(r => r.id.startsWith('REC' + fechaStr));
    const consecutivo = recsHoy.length + 1;
    const id = `REC${fechaStr}-${consecutivo}`;
    
    console.log('ID generado:', id);
    
    const insumo = document.getElementById('insumoRecep').value;
    const cantidad = parseInt(document.getElementById('cantidadRecep').value);
    
    const datos = {
        id:id,
        factura:document.getElementById('factura').value,
        proveedor:document.getElementById('proveedor').value,
        insumo:insumo,
        cantidad:cantidad,
        responsable:document.getElementById('responsableRecep').value,
        fecha:new Date().toISOString()
    };
    
    console.log('Datos a guardar:', datos);
    
    // Guardar recepci√≥n Y actualizar inventario
    database.ref('recepciones/'+id).set(datos).then(()=>{
        console.log('Recepci√≥n guardada exitosamente');
        
        // ACTUALIZAR INVENTARIO: Sumar a Stock Almac√©n
        actualizarInventarioRecepcion(insumo, cantidad).then(()=>{
            document.querySelector('#almacenCard form').reset();
            document.getElementById('responsableRecep').value = currentUser.nombre;
            alert('‚úÖ Recepci√≥n registrada: ' + id + '\nüì¶ Inventario actualizado: +' + cantidad);
        }).catch(err=>{
            console.error('Error al actualizar inventario:', err);
            alert('‚ö†Ô∏è Recepci√≥n guardada pero error al actualizar inventario: ' + err.message);
        });
    }).catch(error => {
        console.error('Error al guardar recepci√≥n:', error);
        alert('‚ùå Error: ' + error.message);
    });
}

function registrarExportacion(){
    console.log('registrarExportacion llamada');
    
    // Generar ID con formato: EXP25012026-1
    const hoy = new Date();
    const dia = String(hoy.getDate()).padStart(2, '0');
    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
    const a√±o = hoy.getFullYear();
    const fechaStr = dia + mes + a√±o;
    
    // Encontrar el consecutivo del d√≠a
    const expsHoy = exportaciones.filter(e => e.id.startsWith('EXP' + fechaStr));
    const consecutivo = expsHoy.length + 1;
    const id = `EXP${fechaStr}-${consecutivo}`;
    
    console.log('ID generado:', id);
    
    const datos = {
        id:id,
        pedido:document.getElementById('pedido').value,
        presentacion:document.getElementById('presentacion').value,
        tipo:document.getElementById('tipo').value,
        cantidadPallets:parseInt(document.getElementById('cantidadPallets').value),
        cantidadCajas:parseInt(document.getElementById('cantidadCajas').value),
        cliente:document.getElementById('clienteExp').value,
        transporte:document.getElementById('transporte').value,
        numeroCandado:document.getElementById('numeroCandado').value,
        operador:document.getElementById('operador').value,
        custodia:document.getElementById('custodia').value,
        responsable:document.getElementById('responsableExp').value,
        fecha:new Date().toISOString()
    };
    
    console.log('Datos a guardar:', datos);
    
    database.ref('exportaciones/'+id).set(datos).then(()=>{
        console.log('Exportaci√≥n guardada exitosamente');
        document.querySelector('#exportacionesCard form').reset();
        alert('‚úÖ Exportaci√≥n registrada: ' + id);
    }).catch(error => {
        console.error('Error al guardar exportaci√≥n:', error);
        alert('‚ùå Error: ' + error.message);
    });
}

// EXCEL 1: PRODUCCI√ìN Y MATERIALISTA (Requisiciones)
// EXCEL 1: ENTREGAS A PRODUCCI√ìN
function descargarExcel(){
    const wb=XLSX.utils.book_new();
    
    // HOJA 1: Entregas a Producci√≥n
    if(entregas.length>0){
        const d1=entregas.map(e=>({
            'ID':e.id,
            'Fecha':new Date(e.fecha).toLocaleString('es-MX'),
            'Insumo':e.insumo,
            'Cantidad':e.cantidad,
            'Entregado a':e.receptor,
            'Responsable':e.responsable,
            'Notas':e.notas||''
        }));
        const ws1=XLSX.utils.json_to_sheet(d1);
        ws1['!cols']=[{wch:15},{wch:20},{wch:35},{wch:12},{wch:20},{wch:20},{wch:30}];
        XLSX.utils.book_append_sheet(wb,ws1,'Entregas Producci√≥n');
    }
    
    XLSX.writeFile(wb,'Entregas_Produccion_'+new Date().toISOString().split('T')[0]+'.xlsx');
}

// EXCEL 2: TODO MENOS REQUISICIONES (Almac√©n + Exportaciones + Trazabilidad + Mermas)
function descargarExcelAlmacen(){
    try {
        const wb=XLSX.utils.book_new();
        let hayDatos=false;
        
        // HOJA 1: Recepciones (Almac√©n)
        if(recepciones && recepciones.length>0){
            const d1=recepciones.map(r=>({
                'ID':r.id||'',
                'Fecha':r.fecha?new Date(r.fecha).toLocaleString('es-MX'):'',
                'Factura':r.factura||'',
                'Proveedor':r.proveedor||'',
                'Insumo':r.insumo||'',
                'Cantidad':r.cantidad||0,
                'Responsable Almac√©n':r.responsable||''
            }));
            const ws1=XLSX.utils.json_to_sheet(d1);
            ws1['!cols']=[{wch:15},{wch:20},{wch:15},{wch:25},{wch:35},{wch:12},{wch:25}];
            XLSX.utils.book_append_sheet(wb,ws1,'Recepciones Almac√©n');
            hayDatos=true;
        }
        
        // HOJA 2: Exportaciones
        if(exportaciones && exportaciones.length>0){
            const d2=exportaciones.map(e=>({
                'ID':e.id||'',
                'Fecha':e.fecha?new Date(e.fecha).toLocaleString('es-MX'):'',
                'N√∫mero Pedido':e.pedido||'',
                'Presentaci√≥n':e.presentacion||'',
                'Tipo':e.tipo||'',
                'Cantidad Pallets':e.cantidadPallets||0,
                'Cantidad Cajas':e.cantidadCajas||0,
                'Cliente Destino':e.cliente||'',
                'Transporte':e.transporte||'',
                'N√∫mero de Candado':e.numeroCandado||'',
                'Operador':e.operador||'',
                'Custodia':e.custodia||'',
                'Responsable Exportaci√≥n':e.responsable||''
            }));
            const ws2=XLSX.utils.json_to_sheet(d2);
            ws2['!cols']=[{wch:15},{wch:20},{wch:18},{wch:15},{wch:15},{wch:12},{wch:12},{wch:30},{wch:15},{wch:18},{wch:20},{wch:20},{wch:25}];
            XLSX.utils.book_append_sheet(wb,ws2,'Exportaciones');
            hayDatos=true;
        }
        
        // HOJA 3: Trazabilidad General
        if(trazabilidad && trazabilidad.length>0){
            const d3=trazabilidad.map(t=>({
                'ID':t.id||'',
                'Fecha':t.fecha||'',
                'Hora':t.hora||'',
                'Cajas Producidas PT':t.cajasProducidas||0,
                'Tipo':t.tipo||'',
                'Lote L√≠quido':t.loteLiquido||'',
                'Pedido':t.pedido||'',
                'Cliente':t.cliente||'',
                'Responsable':t.responsable||''
            }));
            const ws3=XLSX.utils.json_to_sheet(d3);
            ws3['!cols']=[{wch:15},{wch:12},{wch:8},{wch:18},{wch:12},{wch:15},{wch:15},{wch:25},{wch:20}];
            XLSX.utils.book_append_sheet(wb,ws3,'Trazabilidad');
            hayDatos=true;
            
            // HOJA 4: Mermas Detalladas
            const mermasDetalladas=[];
            trazabilidad.forEach(t=>{
                if(t.mermas && Array.isArray(t.mermas) && t.mermas.length>0){
                    t.mermas.forEach(m=>{
                        mermasDetalladas.push({
                            'ID Trazabilidad':t.id||'',
                            'Fecha':t.fecha||'',
                            'Insumo':m.insumo||'',
                            'Cantidad Merma':m.cantidad||0,
                            'Lote L√≠quido':t.loteLiquido||'',
                            'Pedido':t.pedido||'',
                            'Cliente':t.cliente||''
                        });
                    });
                }
            });
            if(mermasDetalladas.length>0){
                const ws4=XLSX.utils.json_to_sheet(mermasDetalladas);
                ws4['!cols']=[{wch:15},{wch:12},{wch:50},{wch:15},{wch:15},{wch:15},{wch:25}];
                XLSX.utils.book_append_sheet(wb,ws4,'Mermas');
            }
        }
        
        if(!hayDatos){
            alert('No hay datos para exportar');
            return;
        }
        
        XLSX.writeFile(wb,'Reporte_Completo_'+new Date().toISOString().split('T')[0]+'.xlsx');
        console.log('Excel completo descargado correctamente');
    } catch(error) {
        console.error('Error al generar Excel completo:', error);
        alert('Error al generar el Excel. Por favor intenta de nuevo.');
    }
}


    </script>
    <script>
        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(reg => console.log('Service Worker registrado'))
                .catch(err => console.log('Error al registrar Service Worker:', err));
        }
    </script>
</body>
</html>
