<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CDR Almac√©n">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    <title>Casa Don Roberto - Sistema de Gesti√≥n</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body{font-family:Arial;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;margin:0}
        .container{max-width:1400px;margin:0 auto}
        h1{color:white;margin-bottom:10px}
        .sync-badge{display:inline-block;background:#10b981;color:white;padding:5px 12px;border-radius:20px;font-size:12px;margin-left:10px}
        .btn{padding:12px 24px;margin:5px;cursor:pointer;border:none;border-radius:8px;font-size:14px;font-weight:600;transition:all 0.2s}
        .btn:disabled{opacity:0.5;cursor:not-allowed}
        .card{background:white;padding:20px;border-radius:12px;margin:20px 0;box-shadow:0 4px 6px rgba(0,0,0,0.1);display:none}
        .card.active{display:block}
        .form-group{margin:15px 0}
        label{display:block;margin-bottom:5px;font-weight:600;color:#333}
        input,select,textarea{width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;box-sizing:border-box;font-family:Arial}
        button[type="submit"]{background:#10b981;color:white;width:100%;padding:12px;border:none;border-radius:6px;cursor:pointer;font-size:16px;font-weight:600}
        .btn-excel{background:#059669;color:white}
        .request-item{background:#f9f9f9;padding:20px;margin:10px 0;border-radius:8px;border-left:4px solid #e0e0e0}
        .request-item.excedente{border-left:4px solid #f59e0b;background:#fffbeb}
        .request-item.pendiente-conf{border-left:4px solid #0ea5e9;background:#e0f2fe}
        .request-item h3{margin:0 0 10px 0;color:#333}
        .request-item p{margin:5px 0;color:#666}
        .btn-approve{background:#3b82f6;color:white}
        .btn-deliver{background:#8b5cf6;color:white}
        .btn-parcialidad{background:#ec4899;color:white}
        .btn-eliminar{background:#ef4444;color:white;width:100%;margin-top:10px}
        .btn-autorizar{background:#10b981;color:white}
        .btn-rechazar{background:#ef4444;color:white}
        .status-pending{color:#f59e0b;font-weight:bold}
        .status-approved{color:#3b82f6;font-weight:bold}
        .status-partial{color:#8b5cf6;font-weight:bold}
        .status-delivered{color:#10b981;font-weight:bold}
        .status-pendiente_confirmacion{color:#0ea5e9;font-weight:bold}
        .status-excedente{color:#f59e0b;font-weight:bold}
        .parcialidad-item{background:#e0f2fe;padding:10px;margin:5px 0;border-radius:4px;font-size:14px;border-left:3px solid #0ea5e9}
        .faltante{color:#ef4444;font-weight:bold;font-size:16px}
        .excedente-warning{background:#fef3c7;border:2px solid #f59e0b;padding:15px;border-radius:8px;margin:10px 0}
        .excedente-warning h4{color:#92400e;margin:0 0 10px 0}
        .client-selector{background:#e0f2fe;border:2px solid #0ea5e9;padding:15px;border-radius:8px;margin-bottom:15px}
        .client-options{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .client-option{padding:12px;border:2px solid #bae6fd;background:white;border-radius:8px;cursor:pointer;text-align:center}
        .client-option:hover{border-color:#0ea5e9}
        .client-option.active{border-color:#0ea5e9;background:#0ea5e9;color:white}
        
        /* LOGIN STYLES */
        .login-container{display:flex;align-items:center;justify-content:center;min-height:100vh}
        .login-card{background:white;padding:40px;border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,0.2);max-width:400px;width:90%}
        .login-card h2{color:#333;margin-bottom:10px;text-align:center}
        .login-card p{color:#666;margin-bottom:30px;text-align:center;font-size:14px}
        .login-form .form-group{margin-bottom:20px}
        .login-form input{font-size:16px}
        .login-btn{background:#667eea;color:white;width:100%;padding:14px;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer}
        .login-btn:hover{background:#5568d3}
        .user-info{background:rgba(255,255,255,0.2);padding:10px 20px;border-radius:8px;display:inline-block;color:white;margin-left:20px}
        .btn-logout{background:#ef4444;color:white;padding:8px 16px;border-radius:6px;font-size:14px}
    </style>
</head>
<body>
    <!-- PANTALLA DE LOGIN -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div style="text-align:center;margin-bottom:20px">
                <img src="logo.png" alt="Casa Don Roberto" style="width:120px;height:120px;object-fit:contain">
            </div>
            <h2>üîê Sistema de Gesti√≥n</h2>
            <p>Ingresa tus credenciales para continuar</p>
            <form class="login-form" onsubmit="event.preventDefault();login()">
                <div class="form-group">
                    <label>Usuario</label>
                    <input type="text" id="loginUser" required placeholder="Ingresa tu usuario">
                </div>
                <div class="form-group">
                    <label>Contrase√±a</label>
                    <input type="password" id="loginPass" required placeholder="Ingresa tu contrase√±a">
                </div>
                <button type="submit" class="login-btn">Iniciar Sesi√≥n</button>
            </form>
            <div id="loginError" style="color:#ef4444;margin-top:15px;text-align:center;display:none"></div>
        </div>
    </div>
    
    <!-- PANTALLA PRINCIPAL (Oculta hasta login) -->
    <div id="mainScreen" style="display:none">
        <div class="container">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <div style="display:flex;align-items:center;gap:15px">
                    <img src="logo.png" alt="Casa Don Roberto" style="height:60px;width:60px;object-fit:contain">
                    <h1 style="margin:0">
                        Sistema de Gesti√≥n de Almac√©n 
                        <span class="sync-badge">üü¢ Conectado</span>
                    </h1>
                </div>
                <div>
                    <span class="user-info" id="userInfo"></span>
                    <button class="btn btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
            </div>
            
            <div style="background:white;padding:20px;border-radius:12px;margin-bottom:20px" id="navButtons">
                <button class="btn" id="btnProduccion" onclick="mostrar('produccion')" style="background:#3b82f6;color:white">üì¶ Producci√≥n</button>
                <button class="btn" id="btnMaterialista" onclick="mostrar('materialista')" style="background:#ec4899;color:white">üìã Materialista</button>
                <button class="btn" id="btnAlmacen" onclick="mostrar('almacen')" style="background:#8b5cf6;color:white">üè¢ Almac√©n</button>
                <button class="btn" id="btnExportaciones" onclick="mostrar('exportaciones')" style="background:#f59e0b;color:white">‚úàÔ∏è Exportaciones</button>
                <button class="btn" id="btnTrazabilidad" onclick="mostrar('trazabilidad')" style="background:#10b981;color:white">üìä Trazabilidad</button>
            </div>
            
            <!-- Estad√≠sticas -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px">
                <div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);border-left:4px solid #f59e0b">
                    <h3 style="margin:0 0 10px 0;color:#92400e;font-size:14px">Solicitudes Pendientes</h3>
                    <div style="font-size:36px;font-weight:bold;color:#f59e0b" id="statPendientes">0</div>
                </div>
                <div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);border-left:4px solid #3b82f6">
                    <h3 style="margin:0 0 10px 0;color:#1e40af;font-size:14px">En Proceso</h3>
                    <div style="font-size:36px;font-weight:bold;color:#3b82f6" id="statProceso">0</div>
                </div>
                <div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);border-left:4px solid #10b981">
                    <h3 style="margin:0 0 10px 0;color:#065f46;font-size:14px">Entregadas</h3>
                    <div style="font-size:36px;font-weight:bold;color:#10b981" id="statEntregadas">0</div>
                </div>
                <div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);border-left:4px solid #8b5cf6">
                    <h3 style="margin:0 0 10px 0;color:#5b21b6;font-size:14px">Recepciones Hoy</h3>
                    <div style="font-size:36px;font-weight:bold;color:#8b5cf6" id="statRecepciones">0</div>
                </div>
                <div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);border-left:4px solid #f59e0b">
                    <h3 style="margin:0 0 10px 0;color:#92400e;font-size:14px">Exportaciones Hoy</h3>
                    <div style="font-size:36px;font-weight:bold;color:#f59e0b" id="statExportaciones">0</div>
                </div>
            </div>
        </div>
        

        <div id="produccionCard" class="card">
            <h2>üì¶ Nueva Requisici√≥n</h2>
            <form onsubmit="event.preventDefault();crearRequisicion()">
                <div class="client-selector">
                    <h3 style="margin:0 0 10px 0">Selecciona el Cliente</h3>
                    <div class="client-options">
                        <div class="client-option active" onclick="selectClient('MI_CAMPO',event)">
                            <h4 style="margin:0">üì¶ MI CAMPO</h4>
                            <p style="margin:5px 0 0 0;font-size:12px">67 insumos</p>
                        </div>
                        <div class="client-option" onclick="selectClient('PELIGROSO',event)">
                            <h4 style="margin:0">üî• PELIGROSO</h4>
                            <p style="margin:5px 0 0 0;font-size:12px">43 insumos</p>
                        </div>
                    </div>
                </div>
                <div class="form-group"><label>Insumo *</label><select id="insumo" required></select></div>
                <div class="form-group"><label>Cantidad *</label><input type="number" id="cantidad" min="1" required></div>
                <div class="form-group"><label>Solicitante *</label><input type="text" id="solicitante" required readonly></div>
                <div class="form-group"><label>Notas</label><textarea id="notas" rows="3"></textarea></div>
                <button type="submit">Crear Requisici√≥n</button>
            </form>
            
            <div style="margin-top:30px;padding-top:20px;border-top:2px solid #e5e7eb">
                <h3>‚ö†Ô∏è Excedentes Pendientes de Autorizaci√≥n</h3>
                <div id="solicitudesExcedente"></div>
            </div>
            
            <div style="margin-top:30px;padding-top:20px;border-top:2px solid #e5e7eb">
                <h3>üìã Mis Solicitudes</h3>
                <button class="btn btn-excel" onclick="descargarExcel()">üìä Descargar Excel</button>
                <div style="margin:20px 0">
                    <button class="btn" onclick="filtrarSolicitudesProduccion('all')" style="background:#6b7280;color:white">Todas</button>
                    <button class="btn" onclick="filtrarSolicitudesProduccion('pending')" style="background:#f59e0b;color:white">Pendientes</button>
                    <button class="btn" onclick="filtrarSolicitudesProduccion('approved')" style="background:#3b82f6;color:white">Aprobadas</button>
                    <button class="btn" onclick="filtrarSolicitudesProduccion('partial')" style="background:#8b5cf6;color:white">Parciales</button>
                    <button class="btn" onclick="filtrarSolicitudesProduccion('delivered')" style="background:#10b981;color:white">Entregadas</button>
                </div>
                <div id="listaSolicitudesProduccion"></div>
            </div>
        </div>

        <div id="materialistaCard" class="card">
            <h2>üìã Gesti√≥n de Solicitudes</h2>
            <button class="btn btn-excel" onclick="descargarExcel()">üìä Descargar Excel</button>
            <div style="margin:20px 0">
                <button class="btn" onclick="filtrarSolicitudes('all')" style="background:#6b7280;color:white">Todas</button>
                <button class="btn" onclick="filtrarSolicitudes('pending')" style="background:#f59e0b;color:white">Pendientes</button>
                <button class="btn" onclick="filtrarSolicitudes('approved')" style="background:#3b82f6;color:white">Aprobadas</button>
                <button class="btn" onclick="filtrarSolicitudes('partial')" style="background:#8b5cf6;color:white">Parciales</button>
                <button class="btn" onclick="filtrarSolicitudes('delivered')" style="background:#10b981;color:white">Entregadas</button>
            </div>
            <div id="listaSolicitudes"></div>
        </div>

        <div id="almacenCard" class="card">
            <h2>üì• Recepci√≥n de Proveedores</h2>
            <form onsubmit="event.preventDefault();registrarRecepcion()">
                <div class="form-group"><label>Factura *</label><input type="text" id="factura" required></div>
                <div class="form-group"><label>Proveedor *</label><input type="text" id="proveedor" required></div>
                <div class="form-group"><label>Insumo *</label><input type="text" id="insumoRecep" required></div>
                <div class="form-group"><label>Cantidad *</label><input type="number" id="cantidadRecep" min="1" required></div>
                <div class="form-group"><label>Responsable *</label><input type="text" id="responsableRecep" required></div>
                <button type="submit">Registrar Recepci√≥n</button>
            </form>
            
            <div style="margin-top:30px;padding-top:20px;border-top:2px solid #e5e7eb">
                <h3>üìã Historial de Recepciones</h3>
                <div id="listaRecepciones"></div>
            </div>
        </div>

        <div id="exportacionesCard" class="card">
            <h2>‚úàÔ∏è Registrar Exportaci√≥n</h2>
            <form onsubmit="event.preventDefault();registrarExportacion()">
                <div class="form-group"><label>N√∫mero de Pedido *</label><input type="text" id="pedido" required></div>
                <div class="form-group"><label>Presentaci√≥n *</label><select id="presentacion" required><option value="">Selecciona...</option><option>50 ml</option><option>375 ml</option><option>700 ml</option><option>750 ml</option><option>1000 ml</option><option>1750 ml</option></select></div>
                <div class="form-group"><label>Tipo *</label><select id="tipo" required><option value="">Selecciona...</option><option>Blanco</option><option>Reposado</option></select></div>
                <div class="form-group"><label>Cantidad de Pallets *</label><input type="number" id="cantidadPallets" min="1" required></div>
                <div class="form-group"><label>Cantidad de Cajas *</label><input type="number" id="cantidadCajas" min="1" required></div>
                <div class="form-group"><label>Cliente *</label><input type="text" id="clienteExp" required></div>
                <div class="form-group"><label>Transporte *</label><select id="transporte" required><option value="">Selecciona...</option><option>Terrestre</option><option>Mar√≠timo</option><option>A√©reo</option></select></div>
                <div class="form-group"><label>Responsable *</label><input type="text" id="responsableExp" required readonly></div>
                <button type="submit">Registrar Exportaci√≥n</button>
            </form>
            
            <div style="margin-top:30px;padding-top:20px;border-top:2px solid #e5e7eb">
                <h3>üìã Historial de Exportaciones</h3>
                <div id="listaExportaciones"></div>
            </div>
        </div>

        <!-- TRAZABILIDAD -->
        <div id="trazabilidadCard" class="card">
            <h2>üìä Registro de Trazabilidad</h2>
            
            <!-- Datos Generales -->
            <div style="background:#e0f2fe;padding:20px;border-radius:8px;margin-bottom:20px">
                <h3 style="margin:0 0 15px 0">üìã Datos Generales</h3>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                    <div class="form-group"><label>Cajas Producidas PT *</label><input type="number" id="cajasProducidas" min="1" required></div>
                    <div class="form-group"><label>Tipo *</label><select id="tipoTraz" required><option value="">Selecciona...</option><option>Blanco</option><option>Reposado</option></select></div>
                    <div class="form-group"><label>Lote de L√≠quido *</label><input type="text" id="loteLiquido" required></div>
                    <div class="form-group"><label>Pedido *</label><input type="text" id="pedidoTraz" required></div>
                    <div class="form-group"><label>Cliente *</label><input type="text" id="clienteTraz" required></div>
                    <div class="form-group"><label>Turno *</label><select id="turnoTraz" required><option value="">Selecciona...</option><option>Matutino</option><option>Vespertino</option></select></div>
                </div>
                <div class="form-group"><label>Responsable *</label><input type="text" id="responsableTraz" required readonly></div>
            </div>
            
            <!-- Mermas -->
            <div style="background:#fef3c7;padding:20px;border-radius:8px;margin-bottom:20px">
                <h3 style="margin:0 0 15px 0">‚ö†Ô∏è Agregar Mermas</h3>
                <div style="display:grid;grid-template-columns:2fr 1fr auto;gap:10px;align-items:end">
                    <div class="form-group" style="margin:0">
                        <label>Insumo</label>
                        <select id="insumoMermaTemp">
                            <option value="">Selecciona...</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin:0">
                        <label>Cantidad</label>
                        <input type="number" id="cantidadMermaTemp" min="0" step="0.01" placeholder="0">
                    </div>
                    <button type="button" class="btn" onclick="agregarMerma()" style="background:#f59e0b;color:white;padding:10px 20px">‚ûï Agregar</button>
                </div>
                
                <div id="listaMermas" style="margin-top:15px"></div>
            </div>
            
            <button type="button" onclick="registrarTrazabilidad()" class="btn" style="background:#10b981;color:white;width:100%;padding:15px;font-size:16px">‚úÖ Registrar Trazabilidad Completa</button>
            
            <div style="margin-top:30px;padding-top:20px;border-top:2px solid #e5e7eb">
                <h3>üìã Historial de Trazabilidad</h3>
                <button class="btn btn-excel" onclick="descargarExcelTrazabilidad()">üìä Descargar Excel</button>
                <div id="listaTrazabilidad"></div>
            </div>
        </div>
    </div>
    <script>
const INSUMOS_MI_CAMPO=[{insumo:"BOTELLA",presentacion:"50 ml",tipo:"GENERAL"},{insumo:"BOTELLA",presentacion:"375ml",tipo:"GENERAL"},{insumo:"BOTELLA",presentacion:"750 ml",tipo:"GENERAL"},{insumo:"BOTELLA",presentacion:"700 ml",tipo:"GENERAL"},{insumo:"BOTELLA",presentacion:"1000 ml",tipo:"GENERAL"},{insumo:"BOTELLA",presentacion:"1750 ml",tipo:"GENERAL"},{insumo:"CAJA",presentacion:"50 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"50 ML",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"375 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"375 ML",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"700 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"700 ML",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"750 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"750 ML",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"750 ML CANADA",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"750 ML CANADA",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"1000 ML",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"1000 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"1.750 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"1.750 ML",tipo:"REPOSADO"},{insumo:"TARIMA CHEP",presentacion:"EST√ÅNDAR MADERA",tipo:"GENERAL"},{insumo:"TARIMA",presentacion:"EST√ÅNDAR MADERA CON POLIN",tipo:"GENERAL"},{insumo:"TAPON PLASTICO",presentacion:"EST√ÅNDAR",tipo:"GENERAL"},{insumo:"CORCHO CASA NOBLE",presentacion:"EST√ÅNDAR",tipo:"GENERAL"},{insumo:"CELOSIL",presentacion:"EST√ÅNDAR",tipo:"GENERAL"},{insumo:"ESQUINEROS",presentacion:"KRAFT 2X2",tipo:"GENERAL"},{insumo:"ROLLOS PLAYO CHICO",presentacion:"18\"",tipo:"GENERAL"},{insumo:"ROLLOS PLAYO GRANDE",presentacion:"20\"",tipo:"GENERAL"},{insumo:"ROLLOS CINTA",presentacion:"48 X 150",tipo:"GENERAL"},{insumo:"ROLLOS FLEJE",presentacion:"1/2 negro",tipo:"GENERAL"},{insumo:"GRAPAS PZ",presentacion:"50ml",tipo:"GENERAL"},{insumo:"ETIQUETA FRENTE",presentacion:"50 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"375 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"700 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"750 ML CANADA",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"1000 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"1750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"50 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"375 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"700 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"750 ML CANADA",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"750 ML USA",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"1000 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"1750 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"50 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"375 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"700 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"750 ML CANADA",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"1000 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"1750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"50 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"375 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"700 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"750 ML CANADA",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"750 ML USA",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"1000 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"1750 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CUELLO",presentacion:"50 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CUELLO",presentacion:"375 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CUELLO",presentacion:"750/700/1000 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CUELLO",presentacion:"1750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CUELLO",presentacion:"50 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CUELLO",presentacion:"375 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CUELLO",presentacion:"750/700/1000 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CUELLO",presentacion:"1750 ML",tipo:"REPOSADO"}];
const INSUMOS_PELIGROSO=[{insumo:"BOTELLA",presentacion:"50 ml",tipo:"GENERAL"},{insumo:"BOTELLA",presentacion:"375ml",tipo:"GENERAL"},{insumo:"BOTELLA",presentacion:"750 ml",tipo:"GENERAL"},{insumo:"BOTELLA",presentacion:"1000 ml",tipo:"GENERAL"},{insumo:"CAJA",presentacion:"50 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"50 ML",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"375 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"375 ML",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"750 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"750 ML",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"1000 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"1000 ML",tipo:"REPOSADO"},{insumo:"TARIMA",presentacion:"EST√ÅNDAR MADERA CON POLIN",tipo:"GENERAL"},{insumo:"TAPON PLASTICO",presentacion:"EST√ÅNDAR",tipo:"GENERAL"},{insumo:"CELOSIL",presentacion:"EST√ÅNDAR",tipo:"GENERAL"},{insumo:"ESQUINEROS",presentacion:"KRAFT 2X2",tipo:"GENERAL"},{insumo:"ROLLOS PLAYO CHICO",presentacion:"18\"",tipo:"GENERAL"},{insumo:"ROLLOS PLAYO GRANDE",presentacion:"20\"",tipo:"GENERAL"},{insumo:"ROLLOS CINTA",presentacion:"48 X 150",tipo:"GENERAL"},{insumo:"ROLLOS FLEJE",presentacion:"1/2 negro",tipo:"GENERAL"},{insumo:"GRAPAS PZ",presentacion:"50ml",tipo:"GENERAL"},{insumo:"ETIQUETA FRENTE",presentacion:"50 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"375 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"1000 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"50 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"375 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"750 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"1000 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"50 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"375 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"1000 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"50 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"375 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"750 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"1000 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CUELLO",presentacion:"50 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CUELLO",presentacion:"375 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CUELLO",presentacion:"750/1000 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CUELLO",presentacion:"50 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CUELLO",presentacion:"375 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CUELLO",presentacion:"750/1000 ML",tipo:"REPOSADO"}];

// CAT√ÅLOGO UNIFICADO PARA TRAZABILIDAD (sin repetir, con todos los insumos)
const INSUMOS_TRAZABILIDAD=[{insumo:"BOTELLA",presentacion:"50 ml",tipo:"GENERAL"},{insumo:"BOTELLA",presentacion:"375ml",tipo:"GENERAL"},{insumo:"BOTELLA",presentacion:"700 ml",tipo:"GENERAL"},{insumo:"BOTELLA",presentacion:"750 ml",tipo:"GENERAL"},{insumo:"BOTELLA",presentacion:"1000 ml",tipo:"GENERAL"},{insumo:"BOTELLA",presentacion:"1750 ml",tipo:"GENERAL"},{insumo:"CAJA",presentacion:"50 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"50 ML",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"375 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"375 ML",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"700 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"700 ML",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"750 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"750 ML",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"750 ML CANADA",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"750 ML CANADA",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"1000 ML",tipo:"REPOSADO"},{insumo:"CAJA",presentacion:"1000 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"1.750 ML",tipo:"BLANCO"},{insumo:"CAJA",presentacion:"1.750 ML",tipo:"REPOSADO"},{insumo:"TARIMA CHEP",presentacion:"EST√ÅNDAR MADERA",tipo:"GENERAL"},{insumo:"TARIMA",presentacion:"EST√ÅNDAR MADERA CON POLIN",tipo:"GENERAL"},{insumo:"TAPON PLASTICO",presentacion:"EST√ÅNDAR",tipo:"GENERAL"},{insumo:"CORCHO CASA NOBLE",presentacion:"EST√ÅNDAR",tipo:"GENERAL"},{insumo:"CELOSIL",presentacion:"EST√ÅNDAR",tipo:"GENERAL"},{insumo:"ESQUINEROS",presentacion:"KRAFT 2X2",tipo:"GENERAL"},{insumo:"ROLLOS PLAYO CHICO",presentacion:"18\"",tipo:"GENERAL"},{insumo:"ROLLOS PLAYO GRANDE",presentacion:"20\"",tipo:"GENERAL"},{insumo:"ROLLOS CINTA",presentacion:"48 X 150",tipo:"GENERAL"},{insumo:"ROLLOS FLEJE",presentacion:"1/2 negro",tipo:"GENERAL"},{insumo:"GRAPAS PZ",presentacion:"50ml",tipo:"GENERAL"},{insumo:"ETIQUETA FRENTE",presentacion:"50 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"375 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"700 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"750 ML CANADA",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"1000 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"1750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA FRENTE",presentacion:"50 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"375 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"700 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"750 ML CANADA",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"750 ML USA",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"1000 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA FRENTE",presentacion:"1750 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"50 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"375 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"700 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"750 ML CANADA",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"1000 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"1750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CONTRA",presentacion:"50 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"375 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"700 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"750 ML CANADA",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"750 ML USA",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"1000 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CONTRA",presentacion:"1750 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CUELLO",presentacion:"50 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CUELLO",presentacion:"375 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CUELLO",presentacion:"750/700/1000 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CUELLO",presentacion:"1750 ML",tipo:"BLANCO"},{insumo:"ETIQUETA CUELLO",presentacion:"50 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CUELLO",presentacion:"375 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CUELLO",presentacion:"750/700/1000 ML",tipo:"REPOSADO"},{insumo:"ETIQUETA CUELLO",presentacion:"1750 ML",tipo:"REPOSADO"}];

firebase.initializeApp({apiKey:"AIzaSyAg-1IW4aE5KXUH4X_VN87NEquGA03972Q",authDomain:"cdr-insumos-2619a.firebaseapp.com",databaseURL:"https://cdr-insumos-2619a-default-rtdb.firebaseio.com",projectId:"cdr-insumos-2619a",storageBucket:"cdr-insumos-2619a.firebasestorage.app",messagingSenderId:"921324842813",appId:"1:921324842813:web:c28cdf61c97cb43c9adf54"});
// SISTEMA DE USUARIOS Y PERMISOS
const USUARIOS = {
    'cristian': {pass:'MAT2026',rol:'materialista',nombre:'Cristian'},
    'grecia': {pass:'MAT2026',rol:'materialista',nombre:'Grecia'},
    'miguel': {pass:'MAT2026',rol:'materialista',nombre:'Miguel'},
    'cristian.montacargas': {pass:'MAT2026',rol:'materialista',nombre:'Cristian (Montacargas)'},
    'esperanza': {pass:'PRO2026',rol:'produccion',nombre:'Esperanza'},
    'jairo': {pass:'PRO2026',rol:'produccion',nombre:'Jairo'},
    'fatima': {pass:'PRO2026',rol:'produccion',nombre:'F√°tima'},
    'jose.manuel': {pass:'PRO2026',rol:'produccion',nombre:'Jos√© Manuel'},
    'juan': {pass:'ALMA2026',rol:'almacen',nombre:'Juan'},
    'eva': {pass:'ALMA2026',rol:'almacen',nombre:'Eva'},
    'trazabilidad': {pass:'TRAZA2026',rol:'trazabilidad',nombre:'Trazabilidad'},
    'orlando': {pass:'ADMIN2026',rol:'admin',nombre:'Orlando'},
    'marisol': {pass:'ADMIN2026',rol:'admin',nombre:'Marisol'},
    'david': {pass:'ADMIN2026',rol:'admin',nombre:'David'}
};
const PERMISOS={produccion:['produccion','trazabilidad'],materialista:['materialista','almacen'],almacen:['materialista','almacen','exportaciones'],trazabilidad:['trazabilidad'],admin:['produccion','materialista','almacen','exportaciones','trazabilidad']};
let currentUser=null;
const database=firebase.database();

let solicitudes=[],recepciones=[],exportaciones=[],trazabilidad=[],filtroActual='all',currentClient='MI_CAMPO',currentInsumos=INSUMOS_MI_CAMPO;

database.ref('requests').on('value',s=>{solicitudes=s.val()?Object.values(s.val()):[];mostrarSolicitudes();mostrarExcedentes();mostrarSolicitudesProduccion();actualizarEstadisticas();});
database.ref('recepciones').on('value',s=>{recepciones=s.val()?Object.values(s.val()):[];mostrarRecepciones();actualizarEstadisticas();});
database.ref('exportaciones').on('value',s=>{exportaciones=s.val()?Object.values(s.val()):[];mostrarExportaciones();actualizarEstadisticas();});
database.ref('trazabilidad').on('value',s=>{trazabilidad=s.val()?Object.values(s.val()):[];mostrarTrazabilidad();});

function login(){const u=document.getElementById("loginUser").value.trim().toLowerCase();const p=document.getElementById("loginPass").value;if(USUARIOS[u]&&USUARIOS[u].pass===p){currentUser={user:u,...USUARIOS[u]};document.getElementById("loginScreen").style.display="none";document.getElementById("mainScreen").style.display="block";document.getElementById("userInfo").textContent="üë§ "+currentUser.nombre+" ("+currentUser.rol.toUpperCase()+")";document.getElementById("solicitante").value=currentUser.nombre;document.getElementById("responsableRecep").value=currentUser.nombre;document.getElementById("responsableExp").value=currentUser.nombre;aplicarPermisos();mostrar(PERMISOS[currentUser.rol][0]);}else{document.getElementById("loginError").textContent="‚ùå Usuario o contrase√±a incorrectos";document.getElementById("loginError").style.display="block";}}
function logout(){if(confirm("¬øCerrar sesi√≥n?")){location.reload();}}
function aplicarPermisos(){const p=PERMISOS[currentUser.rol];document.getElementById("btnProduccion").disabled=!p.includes("produccion");document.getElementById("btnMaterialista").disabled=!p.includes("materialista");document.getElementById("btnAlmacen").disabled=!p.includes("almacen");document.getElementById("btnExportaciones").disabled=!p.includes("exportaciones");document.getElementById("btnTrazabilidad").disabled=!p.includes("trazabilidad");}

function cargarInsumos(){
    const s=document.getElementById('insumo');
    s.innerHTML='<option value="">Selecciona...</option>';
    currentInsumos.forEach((item,i)=>{
        const o=document.createElement('option');
        o.value=i;
        o.textContent=item.insumo+' - '+item.presentacion+' - '+item.tipo;
        s.appendChild(o);
    });
}

function selectClient(c,e){
    if(e){e.preventDefault();e.stopPropagation();}
    currentClient=c;
    currentInsumos=c==='MI_CAMPO'?INSUMOS_MI_CAMPO:INSUMOS_PELIGROSO;
    document.querySelectorAll('.client-option').forEach(o=>o.classList.remove('active'));
    if(e&&e.target){const opt=e.target.closest('.client-option');if(opt)opt.classList.add('active');}
    cargarInsumos();
}

let mermasTemp=[];

function cargarInsumosMerma(){
    const s=document.getElementById('insumoMermaTemp');
    s.innerHTML='<option value="">Selecciona...</option>';
    INSUMOS_TRAZABILIDAD.forEach((item,i)=>{
        const o=document.createElement('option');
        o.value=JSON.stringify(item);
        o.textContent=item.insumo+' - '+item.presentacion+' - '+item.tipo;
        s.appendChild(o);
    });
}

function agregarMerma(){
    const insumoSelect=document.getElementById('insumoMermaTemp');
    const cantidad=parseFloat(document.getElementById('cantidadMermaTemp').value);
    
    if(!insumoSelect.value){
        alert('‚ùå Selecciona un insumo');
        return;
    }
    if(!cantidad || cantidad<=0){
        alert('‚ùå Ingresa una cantidad v√°lida');
        return;
    }
    
    const insumoData=JSON.parse(insumoSelect.value);
    const merma={
        insumo:insumoData.insumo+' - '+insumoData.presentacion+' - '+insumoData.tipo,
        cantidad:cantidad
    };
    
    mermasTemp.push(merma);
    mostrarMermasTemp();
    
    // Limpiar campos
    insumoSelect.selectedIndex=0;
    document.getElementById('cantidadMermaTemp').value='';
}

function mostrarMermasTemp(){
    const lista=document.getElementById('listaMermas');
    if(mermasTemp.length===0){
        lista.innerHTML='<p style="color:#92400e;font-style:italic;margin-top:10px">No hay mermas agregadas. Agrega al menos una.</p>';
        return;
    }
    
    lista.innerHTML='<div style="background:white;padding:15px;border-radius:8px;margin-top:10px">'+
        '<h4 style="margin:0 0 10px 0;color:#92400e">Mermas agregadas ('+mermasTemp.length+'):</h4>'+
        mermasTemp.map((m,i)=>`
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:#fef3c7;border-radius:4px;margin:5px 0">
                <span><strong>${m.insumo}:</strong> ${m.cantidad}</span>
                <button onclick="eliminarMermaTemp(${i})" class="btn" style="background:#ef4444;color:white;padding:5px 10px;font-size:12px">üóëÔ∏è</button>
            </div>
        `).join('')+
    '</div>';
}

function eliminarMermaTemp(index){
    mermasTemp.splice(index,1);
    mostrarMermasTemp();
}

function registrarTrazabilidad(){
    // Validar campos
    if(!document.getElementById('cajasProducidas').value){alert('‚ùå Ingresa cajas producidas');return;}
    if(!document.getElementById('tipoTraz').value){alert('‚ùå Selecciona tipo');return;}
    if(!document.getElementById('loteLiquido').value){alert('‚ùå Ingresa lote de l√≠quido');return;}
    if(!document.getElementById('pedidoTraz').value){alert('‚ùå Ingresa pedido');return;}
    if(!document.getElementById('clienteTraz').value){alert('‚ùå Ingresa cliente');return;}
    if(!document.getElementById('turnoTraz').value){alert('‚ùå Selecciona turno');return;}
    
    if(mermasTemp.length===0){
        alert('‚ùå Debes agregar al menos una merma');
        return;
    }
    
    const ahora=new Date();
    const dia=String(ahora.getDate()).padStart(2,'0');
    const mes=String(ahora.getMonth()+1).padStart(2,'0');
    const a√±o=ahora.getFullYear();
    const fechaStr=dia+mes+a√±o;
    const trazsHoy=trazabilidad.filter(t=>t.id.startsWith('TRAZ'+fechaStr));
    const consecutivo=trazsHoy.length+1;
    const id=`TRAZ${fechaStr}-${consecutivo}`;
    
    // Fecha y hora autom√°ticas
    const fechaISO=ahora.toISOString().split('T')[0];
    const hora=ahora.toTimeString().slice(0,5);
    
    const datos={
        id:id,
        mermas:mermasTemp,
        cajasProducidas:parseInt(document.getElementById('cajasProducidas').value),
        tipo:document.getElementById('tipoTraz').value,
        loteLiquido:document.getElementById('loteLiquido').value,
        pedido:document.getElementById('pedidoTraz').value,
        cliente:document.getElementById('clienteTraz').value,
        turno:document.getElementById('turnoTraz').value,
        fecha:fechaISO,
        hora:hora,
        responsable:document.getElementById('responsableTraz').value,
        timestamp:ahora.toISOString()
    };
    
    database.ref('trazabilidad/'+id).set(datos)
        .then(()=>{
            alert('‚úÖ Trazabilidad registrada con '+mermasTemp.length+' merma(s)');
            limpiarFormularioTrazabilidad();
        })
        .catch(err=>alert('Error: '+err.message));
}

function limpiarFormularioTrazabilidad(){
    mermasTemp=[];
    mostrarMermasTemp();
    document.getElementById('cajasProducidas').value='';
    document.getElementById('tipoTraz').selectedIndex=0;
    document.getElementById('loteLiquido').value='';
    document.getElementById('pedidoTraz').value='';
    document.getElementById('clienteTraz').value='';
    document.getElementById('turnoTraz').selectedIndex=0;
    document.getElementById('responsableTraz').value=currentUser.nombre;
}

function mostrarTrazabilidad(){
    const lista=document.getElementById('listaTrazabilidad');
    if(trazabilidad.length===0){
        lista.innerHTML='<p style="color:#666">No hay registros de trazabilidad</p>';
        return;
    }
    lista.innerHTML=trazabilidad.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)).map(t=>`
        <div class="request-item">
            <h3>${t.id}</h3>
            <p><strong>Fecha:</strong> ${t.fecha} - <strong>Hora:</strong> ${t.hora}</p>
            <div style="background:#fef3c7;padding:10px;border-radius:4px;margin:10px 0">
                <strong>‚ö†Ô∏è Mermas (${t.mermas?t.mermas.length:0}):</strong>
                ${t.mermas?t.mermas.map(m=>`<div style="margin:5px 0">‚Ä¢ ${m.insumo}: <strong>${m.cantidad}</strong></div>`).join(''):'Sin mermas'}
            </div>
            <p><strong>Cajas Producidas PT:</strong> ${t.cajasProducidas}</p>
            <p><strong>Tipo:</strong> ${t.tipo}</p>
            <p><strong>Lote L√≠quido:</strong> ${t.loteLiquido}</p>
            <p><strong>Pedido:</strong> ${t.pedido}</p>
            <p><strong>Cliente:</strong> ${t.cliente}</p>
            <p><strong>Turno:</strong> ${t.turno}</p>
            <p><strong>Responsable:</strong> ${t.responsable}</p>
            <button class="btn btn-eliminar" onclick="eliminarTrazabilidad('${t.id}')">üóëÔ∏è Eliminar</button>
        </div>
    `).join('');
}

function eliminarTrazabilidad(id){
    if(confirm('¬øEliminar este registro de trazabilidad?')){
        database.ref('trazabilidad/'+id).remove().then(()=>alert('‚úÖ Eliminado')).catch(err=>alert('Error: '+err.message));
    }
}

function descargarExcelTrazabilidad(){
    if(trazabilidad.length===0){alert('No hay datos para exportar');return;}
    const wb=XLSX.utils.book_new();
    const d=trazabilidad.map(t=>{
        const mermasDetalle=t.mermas?t.mermas.map(m=>`${m.insumo}: ${m.cantidad}`).join(' | '):'Sin mermas';
        return {
            'ID':t.id,
            'Fecha':t.fecha,
            'Hora':t.hora,
            'Mermas (Detalle)':mermasDetalle,
            'Total Mermas':t.mermas?t.mermas.length:0,
            'Cajas Producidas PT':t.cajasProducidas,
            'Tipo':t.tipo,
            'Lote L√≠quido':t.loteLiquido,
            'Pedido':t.pedido,
            'Cliente':t.cliente,
            'Turno':t.turno,
            'Responsable':t.responsable
        };
    });
    const ws=XLSX.utils.json_to_sheet(d);
    ws['!cols']=[{wch:15},{wch:12},{wch:8},{wch:60},{wch:12},{wch:18},{wch:12},{wch:15},{wch:15},{wch:25},{wch:12},{wch:20}];
    XLSX.utils.book_append_sheet(wb,ws,'Trazabilidad');
    XLSX.writeFile(wb,'Trazabilidad_'+new Date().toISOString().split('T')[0]+'.xlsx');
}

function mostrar(cual){if(!PERMISOS[currentUser.rol].includes(cual)){alert("‚ùå No tienes permisos");return;}
    document.querySelectorAll('.card').forEach(c=>c.classList.remove('active'));
    document.getElementById(cual+'Card').classList.add('active');
    if(cual==='materialista')mostrarSolicitudes();
    if(cual==='produccion'){mostrarExcedentes();mostrarSolicitudesProduccion();}
    if(cual==='almacen')mostrarRecepciones();
    if(cual==='exportaciones')mostrarExportaciones();
    if(cual==='trazabilidad'){mostrarTrazabilidad();cargarInsumosMerma();limpiarFormularioTrazabilidad();}
}

function crearRequisicion(){
    const idx=document.getElementById('insumo').value;
    const ins=currentInsumos[idx];
    
    // Generar ID con formato: REQ25012026-1
    const hoy = new Date();
    const dia = String(hoy.getDate()).padStart(2, '0');
    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
    const a√±o = hoy.getFullYear();
    const fechaStr = dia + mes + a√±o;
    
    // Encontrar el consecutivo del d√≠a
    const reqsHoy = solicitudes.filter(r => r.id.startsWith('REQ' + fechaStr));
    const consecutivo = reqsHoy.length + 1;
    const id = `REQ${fechaStr}-${consecutivo}`;
    
    database.ref('requests/'+id).set({
        id:id,
        cliente:currentClient,
        insumo:ins.insumo+' - '+ins.presentacion+' - '+ins.tipo,
        cantidad:parseInt(document.getElementById('cantidad').value),
        solicitante:document.getElementById('solicitante').value,
        notas:document.getElementById('notas').value,
        fecha:new Date().toISOString(),
        status:'pending',
        parcialidades:[],
        cantidadEntregadaTotal:0
    }).then(()=>{
        document.querySelector('#produccionCard form').reset();
        cargarInsumos();
        alert('‚úÖ Requisici√≥n creada: '+id);
    });
}

function filtrarSolicitudes(f){
    filtroActual=f;
    mostrarSolicitudes();
}

function mostrarSolicitudes(){
    const lista=document.getElementById('listaSolicitudes');
    let filtradas=solicitudes;
    if(filtroActual!=='all')filtradas=solicitudes.filter(r=>r.status===filtroActual);
    if(filtradas.length===0){lista.innerHTML='<p>No hay solicitudes</p>';return;}
    
    lista.innerHTML=filtradas.map(req=>{
        const entregado=req.cantidadEntregadaTotal||0;
        const faltante=req.cantidad-entregado;
        const excedente=entregado>req.cantidad?entregado-req.cantidad:0;
        const parcialidades=req.parcialidades||[];
        let estadoTexto='Pendiente';
        if(req.status==='approved')estadoTexto='Aprobada';
        else if(req.status==='partial')estadoTexto='Parcial';
        else if(req.status==='delivered')estadoTexto='Entregada';
        else if(req.status==='excedente')estadoTexto='Excedente pendiente';
        
        return `
            <div class="request-item ${req.status==='excedente'?'excedente':''}">
                <h3>${req.id}</h3>
                <p><strong>Cliente:</strong> ${req.cliente}</p>
                <p><strong>Insumo:</strong> ${req.insumo}</p>
                <p><strong>Cantidad Solicitada:</strong> ${req.cantidad}</p>
                <p><strong>Cantidad Entregada:</strong> ${entregado}</p>
                ${faltante>0?`<p class="faltante">‚ö†Ô∏è <strong>Faltante:</strong> ${faltante}</p>`:''}
                ${excedente>0?`<p style="color:#f59e0b;font-weight:bold">‚ö†Ô∏è <strong>Excedente:</strong> ${excedente} (Pendiente autorizaci√≥n)</p>`:''}
                <p><strong>Solicitante:</strong> ${req.solicitante}</p>
                ${req.materialista?`<p><strong>Materialista:</strong> ${req.materialista}</p>`:''}
                <p><strong>Estado:</strong> <span class="status-${req.status}">${estadoTexto}</span></p>
                
                ${parcialidades.length>0?`
                    <div style="margin-top:10px">
                        <strong>üì¶ Parcialidades (${parcialidades.length}):</strong>
                        ${parcialidades.map((p,i)=>`
                            <div class="parcialidad-item">
                                #${i+1}: <strong>${p.cantidad}</strong> unidades - ${p.receptor} (${new Date(p.fecha).toLocaleDateString('es-MX')})
                            </div>
                        `).join('')}
                    </div>
                `:''}
                
                <div style="margin-top:15px">
                    ${req.status==='pending'?`<button class="btn btn-approve" onclick="aprobar('${req.id}')">Aprobar</button>`:''}
                    ${req.status==='approved'||req.status==='partial'?`
                        <button class="btn btn-deliver" onclick="entregarCompleto('${req.id}',${req.cantidad})">Entregar Todo</button>
                        <button class="btn btn-parcialidad" onclick="agregarParcialidad('${req.id}',${req.cantidad})">Agregar Parcialidad</button>
                    `:''}
                </div>
                
                <button class="btn btn-eliminar" onclick="eliminarSolicitud('${req.id}')">üóëÔ∏è Eliminar Solicitud</button>
            </div>
        `;
    }).join('');
}

function mostrarExcedentes(){
    const div=document.getElementById('solicitudesExcedente');
    if(!currentUser){return;}
    
    // Filtrar solo excedentes del usuario actual
    const excedentes=solicitudes.filter(r=>r.status==='excedente' && r.solicitante===currentUser.nombre);
    
    if(excedentes.length===0){
        div.innerHTML='<p style="color:#666">No hay excedentes pendientes de autorizaci√≥n</p>';
        return;
    }
    
    div.innerHTML=excedentes.map(req=>{
        const excedente=(req.cantidadEntregadaTotal||0)-req.cantidad;
        return `
            <div class="excedente-warning">
                <h4>‚ö†Ô∏è Excedente en ${req.id}</h4>
                <p><strong>Insumo:</strong> ${req.insumo}</p>
                <p><strong>Solicitado:</strong> ${req.cantidad}</p>
                <p><strong>Entregado:</strong> ${req.cantidadEntregadaTotal}</p>
                <p style="color:#f59e0b;font-weight:bold"><strong>Excedente:</strong> ${excedente} unidades</p>
                <div style="margin-top:10px">
                    <button class="btn btn-autorizar" onclick="autorizarExcedente('${req.id}')">‚úÖ Autorizar Excedente</button>
                    <button class="btn btn-rechazar" onclick="rechazarExcedente('${req.id}')">‚ùå Rechazar</button>
                </div>
            </div>
        `;
    }).join('');
}

let filtroProduccion='all';

function filtrarSolicitudesProduccion(filtro){
    filtroProduccion=filtro;
    mostrarSolicitudesProduccion();
}

function mostrarSolicitudesProduccion(){
    const lista=document.getElementById('listaSolicitudesProduccion');
    if(!currentUser){return;}
    
    // Filtrar solo las solicitudes del usuario actual
    let misSolicitudes=solicitudes.filter(r=>r.solicitante===currentUser.nombre);
    
    // Aplicar filtro de estado
    if(filtroProduccion!=='all'){
        misSolicitudes=misSolicitudes.filter(r=>r.status===filtroProduccion);
    }
    
    if(misSolicitudes.length===0){
        lista.innerHTML='<p style="color:#666">No hay solicitudes</p>';
        return;
    }
    
    lista.innerHTML=misSolicitudes.map(req=>{
        const entregado=req.cantidadEntregadaTotal||0;
        const faltante=req.cantidad-entregado;
        const excedente=entregado>req.cantidad?entregado-req.cantidad:0;
        const parcialidades=req.parcialidades||[];
        let estadoTexto='Pendiente';
        if(req.status==='approved')estadoTexto='Aprobada';
        else if(req.status==='partial')estadoTexto='Parcial';
        else if(req.status==='pendiente_confirmacion')estadoTexto='Pendiente Confirmaci√≥n';
        else if(req.status==='delivered')estadoTexto='Entregada';
        else if(req.status==='excedente')estadoTexto='Excedente pendiente';
        
        return `
            <div class="request-item ${req.status==='excedente'?'excedente':req.status==='pendiente_confirmacion'?'pendiente-conf':''}">
                <h3>${req.id}</h3>
                <p><strong>Cliente:</strong> ${req.cliente}</p>
                <p><strong>Insumo:</strong> ${req.insumo}</p>
                <p><strong>Cantidad Solicitada:</strong> ${req.cantidad}</p>
                <p><strong>Cantidad Entregada:</strong> ${entregado}</p>
                ${faltante>0 && req.status!=='pendiente_confirmacion'?`<p class="faltante">‚ö†Ô∏è <strong>Faltante:</strong> ${faltante}</p>`:''}
                ${excedente>0?`<p style="color:#f59e0b;font-weight:bold">‚ö†Ô∏è <strong>Excedente:</strong> ${excedente} (Pendiente autorizaci√≥n)</p>`:''}
                ${req.materialista?`<p><strong>Materialista:</strong> ${req.materialista}</p>`:''}
                <p><strong>Estado:</strong> <span class="status-${req.status}">${estadoTexto}</span></p>
                
                ${parcialidades.length>0?`
                    <div style="margin-top:10px">
                        <strong>üì¶ Parcialidades (${parcialidades.length}):</strong>
                        ${parcialidades.map((p,i)=>`
                            <div class="parcialidad-item">
                                #${i+1}: <strong>${p.cantidad}</strong> unidades - ${p.receptor} (${new Date(p.fecha).toLocaleDateString('es-MX')})
                            </div>
                        `).join('')}
                    </div>
                `:''}
                
                ${req.status==='excedente'?`
                    <div style="margin-top:15px">
                        <button class="btn btn-autorizar" onclick="autorizarExcedente('${req.id}')">‚úÖ Autorizar Excedente</button>
                        <button class="btn btn-rechazar" onclick="rechazarExcedente('${req.id}')">‚ùå Rechazar</button>
                    </div>
                `:''}
                
                ${req.status==='pendiente_confirmacion'?`
                    <div style="margin-top:15px;background:#e0f2fe;padding:15px;border-radius:8px;border:2px solid#0ea5e9">
                        <p style="margin:0 0 10px 0;color:#0c4a6e;font-weight:bold">‚úã Materialista ha entregado los materiales. Por favor confirma que los recibiste correctamente.</p>
                        <button class="btn btn-autorizar" onclick="confirmarRecepcion('${req.id}')">‚úÖ Confirmar Recepci√≥n</button>
                    </div>
                `:''}
                
                ${req.status==='delivered' && req.confirmadoPor?`
                    <p style="color:#10b981;font-weight:bold;margin-top:10px">‚úÖ Confirmado por: ${req.confirmadoPor} (${new Date(req.fechaConfirmacion).toLocaleString('es-MX')})</p>
                `:''}
            </div>
        `;
    }).join('');
}

function mostrarRecepciones(){
    const lista=document.getElementById('listaRecepciones');
    if(recepciones.length===0){
        lista.innerHTML='<p style="color:#666">No hay recepciones registradas</p>';
        return;
    }
    
    lista.innerHTML=recepciones.sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).map(rec=>`
        <div class="request-item">
            <h3>${rec.id}</h3>
            <p><strong>Fecha:</strong> ${new Date(rec.fecha).toLocaleString('es-MX')}</p>
            <p><strong>Factura:</strong> ${rec.factura}</p>
            <p><strong>Proveedor:</strong> ${rec.proveedor}</p>
            <p><strong>Insumo:</strong> ${rec.insumo}</p>
            <p><strong>Cantidad:</strong> ${rec.cantidad.toLocaleString()}</p>
            <p><strong>Responsable:</strong> ${rec.responsable}</p>
            <button class="btn btn-eliminar" onclick="eliminarRecepcion('${rec.id}')">üóëÔ∏è Eliminar</button>
        </div>
    `).join('');
}

function mostrarExportaciones(){
    const lista=document.getElementById('listaExportaciones');
    if(exportaciones.length===0){
        lista.innerHTML='<p style="color:#666">No hay exportaciones registradas</p>';
        return;
    }
    
    lista.innerHTML=exportaciones.sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).map(exp=>`
        <div class="request-item">
            <h3>${exp.id}</h3>
            <p><strong>Fecha:</strong> ${new Date(exp.fecha).toLocaleString('es-MX')}</p>
            <p><strong>Pedido:</strong> ${exp.pedido}</p>
            <p><strong>Presentaci√≥n:</strong> ${exp.presentacion}</p>
            <p><strong>Tipo:</strong> ${exp.tipo}</p>
            <p><strong>Cantidad Pallets:</strong> ${exp.cantidadPallets||'N/A'}</p>
            <p><strong>Cantidad Cajas:</strong> ${exp.cantidadCajas||'N/A'}</p>
            <p><strong>Cliente:</strong> ${exp.cliente}</p>
            <p><strong>Transporte:</strong> ${exp.transporte}</p>
            <p><strong>Responsable:</strong> ${exp.responsable}</p>
            <button class="btn btn-eliminar" onclick="eliminarExportacion('${exp.id}')">üóëÔ∏è Eliminar</button>
        </div>
    `).join('');
}

function actualizarEstadisticas(){
    // Solicitudes
    const pendientes = solicitudes.filter(r => r.status === 'pending').length;
    const proceso = solicitudes.filter(r => r.status === 'approved' || r.status === 'partial' || r.status === 'pendiente_confirmacion').length;
    const entregadas = solicitudes.filter(r => r.status === 'delivered').length;
    
    // Recepciones y Exportaciones de hoy
    const hoy = new Date();
    const diaHoy = hoy.getDate();
    const mesHoy = hoy.getMonth();
    const a√±oHoy = hoy.getFullYear();
    
    const recepcionesHoy = recepciones.filter(r => {
        const fechaRec = new Date(r.fecha);
        return fechaRec.getDate() === diaHoy && fechaRec.getMonth() === mesHoy && fechaRec.getFullYear() === a√±oHoy;
    }).length;
    
    const exportacionesHoy = exportaciones.filter(e => {
        const fechaExp = new Date(e.fecha);
        return fechaExp.getDate() === diaHoy && fechaExp.getMonth() === mesHoy && fechaExp.getFullYear() === a√±oHoy;
    }).length;
    
    // Actualizar DOM
    document.getElementById('statPendientes').textContent = pendientes;
    document.getElementById('statProceso').textContent = proceso;
    document.getElementById('statEntregadas').textContent = entregadas;
    document.getElementById('statRecepciones').textContent = recepcionesHoy;
    document.getElementById('statExportaciones').textContent = exportacionesHoy;
}

function aprobar(id){
    const materialista=currentUser.nombre;
    if(!materialista)return;
    database.ref('requests/'+id).update({
        status:'approved',
        materialista:materialista,
        fechaAprobacion:new Date().toISOString()
    }).then(()=>alert('‚úÖ Aprobada'));
}

function entregarCompleto(id,cantidadSolicitada){
    const cantidad=parseInt(prompt(`Cantidad a entregar (Solicitado: ${cantidadSolicitada}):`));
    if(!cantidad||cantidad<=0){alert('Cantidad inv√°lida');return;}
    
    const receptor=prompt('¬øQui√©n recibe? (nombre del receptor en producci√≥n)');
    if(!receptor)return;
    
    const req=solicitudes.find(r=>r.id===id);
    const p=req.parcialidades||[];
    const total=(req.cantidadEntregadaTotal||0)+cantidad;
    
    p.push({cantidad:cantidad,receptor:receptor,fecha:new Date().toISOString()});
    
    // Si entrega M√ÅS de lo solicitado
    if(total>req.cantidad){
        database.ref('requests/'+id).update({
            status:'excedente',
            parcialidades:p,
            cantidadEntregadaTotal:total
        }).then(()=>alert('‚ö†Ô∏è Excedente detectado. El solicitante debe autorizar.'));
    } else {
        // SIEMPRE pendiente de confirmaci√≥n (parcial o completa)
        database.ref('requests/'+id).update({
            status:'pendiente_confirmacion',
            parcialidades:p,
            cantidadEntregadaTotal:total
        }).then(()=>alert('‚úÖ Entrega registrada. Pendiente de confirmaci√≥n por Producci√≥n.'));
    }
}

function agregarParcialidad(id,cantidadSolicitada){
    const cantidad=parseInt(prompt(`Cantidad a entregar (Solicitado: ${cantidadSolicitada}):`));
    if(!cantidad||cantidad<=0){alert('Cantidad inv√°lida');return;}
    
    const receptor=prompt('¬øQui√©n recibe? (nombre del receptor en producci√≥n)');
    if(!receptor)return;
    
    const req=solicitudes.find(r=>r.id===id);
    const p=req.parcialidades||[];
    const total=(req.cantidadEntregadaTotal||0)+cantidad;
    
    p.push({cantidad:cantidad,receptor:receptor,fecha:new Date().toISOString()});
    
    // Si entrega M√ÅS de lo solicitado
    if(total>req.cantidad){
        database.ref('requests/'+id).update({
            status:'excedente',
            parcialidades:p,
            cantidadEntregadaTotal:total
        }).then(()=>alert('‚ö†Ô∏è Excedente detectado. El solicitante debe autorizar.'));
    } else {
        // SIEMPRE pendiente de confirmaci√≥n
        database.ref('requests/'+id).update({
            status:'pendiente_confirmacion',
            parcialidades:p,
            cantidadEntregadaTotal:total
        }).then(()=>alert('‚úÖ Parcialidad registrada. Pendiente de confirmaci√≥n por Producci√≥n.'));
    }
}

function autorizarExcedente(id){
    const req=solicitudes.find(r=>r.id===id);
    if(confirm(`¬øAutorizar el excedente?\n\nSolicitado: ${req.cantidad}\nEntregado: ${req.cantidadEntregadaTotal}\nExcedente: ${req.cantidadEntregadaTotal-req.cantidad}\n\nSe actualizar√° la cantidad solicitada.`)){
        database.ref('requests/'+id).update({
            cantidad:req.cantidadEntregadaTotal,
            status:'delivered'
        }).then(()=>alert('‚úÖ Excedente autorizado. Cantidad actualizada.'));
    }
}

function rechazarExcedente(id){
    const req=solicitudes.find(r=>r.id===id);
    const excedente=req.cantidadEntregadaTotal-req.cantidad;
    
    if(confirm(`¬øRechazar el excedente de ${excedente} unidades?\n\nSe revertir√° la √∫ltima entrega.`)){
        const p=req.parcialidades||[];
        const ultimaParcialidad=p[p.length-1];
        
        // Revertir √∫ltima parcialidad
        p.pop();
        const nuevoTotal=req.cantidadEntregadaTotal-ultimaParcialidad.cantidad;
        const status=nuevoTotal>=req.cantidad?'pendiente_confirmacion':nuevoTotal>0?'partial':'approved';
        
        database.ref('requests/'+id).update({
            status:status,
            parcialidades:p,
            cantidadEntregadaTotal:nuevoTotal
        }).then(()=>alert('‚ùå Excedente rechazado. Entrega revertida.'));
    }
}

function confirmarRecepcion(id){
    if(confirm('¬øConfirmar que recibiste todos los materiales correctamente?')){
        database.ref('requests/'+id).update({
            status:'delivered',
            fechaConfirmacion:new Date().toISOString(),
            confirmadoPor:currentUser.nombre
        }).then(()=>alert('‚úÖ Recepci√≥n confirmada. Solicitud completada.'));
    }
}

function eliminarSolicitud(id){
    if(confirm('¬øSeguro que quieres eliminar esta solicitud?\n\nID: '+id+'\n\nEsta acci√≥n no se puede deshacer.')){
        database.ref('requests/'+id).remove()
            .then(()=>alert('‚úÖ Solicitud eliminada'))
            .catch(()=>alert('‚ùå Error al eliminar'));
    }
}

function eliminarRecepcion(id){
    if(confirm('¬øSeguro que quieres eliminar esta recepci√≥n?\n\nID: '+id+'\n\nEsta acci√≥n no se puede deshacer.')){
        database.ref('recepciones/'+id).remove()
            .then(()=>alert('‚úÖ Recepci√≥n eliminada'))
            .catch(()=>alert('‚ùå Error al eliminar'));
    }
}

function eliminarExportacion(id){
    if(confirm('¬øSeguro que quieres eliminar esta exportaci√≥n?\n\nID: '+id+'\n\nEsta acci√≥n no se puede deshacer.')){
        database.ref('exportaciones/'+id).remove()
            .then(()=>alert('‚úÖ Exportaci√≥n eliminada'))
            .catch(()=>alert('‚ùå Error al eliminar'));
    }
}

function registrarRecepcion(){
    console.log('registrarRecepcion llamada');
    
    // Generar ID con formato: REC25012026-1
    const hoy = new Date();
    const dia = String(hoy.getDate()).padStart(2, '0');
    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
    const a√±o = hoy.getFullYear();
    const fechaStr = dia + mes + a√±o;
    
    // Encontrar el consecutivo del d√≠a
    const recsHoy = recepciones.filter(r => r.id.startsWith('REC' + fechaStr));
    const consecutivo = recsHoy.length + 1;
    const id = `REC${fechaStr}-${consecutivo}`;
    
    console.log('ID generado:', id);
    
    const datos = {
        id:id,
        factura:document.getElementById('factura').value,
        proveedor:document.getElementById('proveedor').value,
        insumo:document.getElementById('insumoRecep').value,
        cantidad:parseInt(document.getElementById('cantidadRecep').value),
        responsable:document.getElementById('responsableRecep').value,
        fecha:new Date().toISOString()
    };
    
    console.log('Datos a guardar:', datos);
    
    database.ref('recepciones/'+id).set(datos).then(()=>{
        console.log('Recepci√≥n guardada exitosamente');
        document.querySelector('#almacenCard form').reset();
        alert('‚úÖ Recepci√≥n registrada: ' + id);
    }).catch(error => {
        console.error('Error al guardar recepci√≥n:', error);
        alert('‚ùå Error: ' + error.message);
    });
}

function registrarExportacion(){
    console.log('registrarExportacion llamada');
    
    // Generar ID con formato: EXP25012026-1
    const hoy = new Date();
    const dia = String(hoy.getDate()).padStart(2, '0');
    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
    const a√±o = hoy.getFullYear();
    const fechaStr = dia + mes + a√±o;
    
    // Encontrar el consecutivo del d√≠a
    const expsHoy = exportaciones.filter(e => e.id.startsWith('EXP' + fechaStr));
    const consecutivo = expsHoy.length + 1;
    const id = `EXP${fechaStr}-${consecutivo}`;
    
    console.log('ID generado:', id);
    
    const datos = {
        id:id,
        pedido:document.getElementById('pedido').value,
        presentacion:document.getElementById('presentacion').value,
        tipo:document.getElementById('tipo').value,
        cantidadPallets:parseInt(document.getElementById('cantidadPallets').value),
        cantidadCajas:parseInt(document.getElementById('cantidadCajas').value),
        cliente:document.getElementById('clienteExp').value,
        transporte:document.getElementById('transporte').value,
        responsable:document.getElementById('responsableExp').value,
        fecha:new Date().toISOString()
    };
    
    console.log('Datos a guardar:', datos);
    
    database.ref('exportaciones/'+id).set(datos).then(()=>{
        console.log('Exportaci√≥n guardada exitosamente');
        document.querySelector('#exportacionesCard form').reset();
        alert('‚úÖ Exportaci√≥n registrada: ' + id);
    }).catch(error => {
        console.error('Error al guardar exportaci√≥n:', error);
        alert('‚ùå Error: ' + error.message);
    });
}

function descargarExcel(){
    const wb=XLSX.utils.book_new();
    
    // HOJA 1: Requisiciones COMPLETAS
    if(solicitudes.length>0){
        const d1=solicitudes.map(r=>{
            const parcialidades=r.parcialidades||[];
            const detallesParcialidades=parcialidades.map((p,i)=>`#${i+1}: ${p.cantidad} uds - ${p.receptor} (${new Date(p.fecha).toLocaleDateString('es-MX')})`).join(' | ');
            
            return {
                'ID':r.id,
                'Fecha Solicitud':new Date(r.fecha).toLocaleString('es-MX'),
                'Cliente':r.cliente,
                'Insumo':r.insumo,
                'Cantidad Solicitada':r.cantidad,
                'Cantidad Entregada':r.cantidadEntregadaTotal||0,
                'Diferencia':(r.cantidadEntregadaTotal||0)-r.cantidad,
                'Estado':r.status==='pending'?'Pendiente':r.status==='approved'?'Aprobada':r.status==='partial'?'Parcial':r.status==='pendiente_confirmacion'?'Pendiente Confirmaci√≥n':r.status==='excedente'?'Excedente Pendiente':'Entregada',
                'Solicitante (Producci√≥n)':r.solicitante,
                'Materialista':r.materialista||'Pendiente',
                'Fecha Aprobaci√≥n':r.fechaAprobaci√≥n?new Date(r.fechaAprobacion).toLocaleString('es-MX'):'Pendiente',
                'Confirmado Por':r.confirmadoPor||'Pendiente',
                'Fecha Confirmaci√≥n':r.fechaConfirmacion?new Date(r.fechaConfirmacion).toLocaleString('es-MX'):'Pendiente',
                'Notas':r.notas||'',
                'Total Parcialidades':parcialidades.length,
                'Detalle Parcialidades':detallesParcialidades||'Sin entregas',
                'Receptores':parcialidades.map(p=>p.receptor).join(', ')||'Pendiente'
            };
        });
        const ws1=XLSX.utils.json_to_sheet(d1);
        ws1['!cols']=[{wch:15},{wch:20},{wch:15},{wch:35},{wch:12},{wch:12},{wch:10},{wch:20},{wch:20},{wch:20},{wch:20},{wch:20},{wch:20},{wch:30},{wch:12},{wch:60},{wch:30}];
        XLSX.utils.book_append_sheet(wb,ws1,'Requisiciones');
    }
    
    // HOJA 2: Recepciones
    if(recepciones.length>0){
        const d2=recepciones.map(r=>({
            'ID':r.id,
            'Fecha':new Date(r.fecha).toLocaleString('es-MX'),
            'Factura':r.factura,
            'Proveedor':r.proveedor,
            'Insumo':r.insumo,
            'Cantidad':r.cantidad,
            'Responsable Almac√©n':r.responsable
        }));
        const ws2=XLSX.utils.json_to_sheet(d2);
        ws2['!cols']=[{wch:15},{wch:20},{wch:15},{wch:25},{wch:35},{wch:12},{wch:25}];
        XLSX.utils.book_append_sheet(wb,ws2,'Recepciones');
    }
    
    // HOJA 3: Exportaciones
    if(exportaciones.length>0){
        const d3=exportaciones.map(e=>({
            'ID':e.id,
            'Fecha':new Date(e.fecha).toLocaleString('es-MX'),
            'N√∫mero Pedido':e.pedido,
            'Presentaci√≥n':e.presentacion,
            'Tipo':e.tipo,
            'Cantidad Pallets':e.cantidadPallets||0,
            'Cantidad Cajas':e.cantidadCajas||0,
            'Cliente Destino':e.cliente,
            'Transporte':e.transporte,
            'Responsable Exportaci√≥n':e.responsable
        }));
        const ws3=XLSX.utils.json_to_sheet(d3);
        ws3['!cols']=[{wch:15},{wch:20},{wch:18},{wch:15},{wch:15},{wch:12},{wch:12},{wch:30},{wch:15},{wch:25}];
        XLSX.utils.book_append_sheet(wb,ws3,'Exportaciones');
    }
    
    XLSX.writeFile(wb,'Reporte_Completo_'+new Date().toISOString().split('T')[0]+'.xlsx');
}

    </script>
    <script>
        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(reg => console.log('Service Worker registrado'))
                .catch(err => console.log('Error al registrar Service Worker:', err));
        }
    </script>
</body>
</html>
